<!DOCTYPE html><html><head><meta charSet="utf-8" data-next-head=""/><meta name="viewport" content="width=device-width" data-next-head=""/><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3DGNKE718G"></script><meta http-equiv="x-ua-compatible" content="IE=edge; chrome=1" data-next-head=""/><meta name="application-name" content="gwl002&#x27;s blog" data-next-head=""/><title data-next-head="">暮天云光-rxjs实现贪吃蛇小游戏</title><meta name="robots" content="index,follow" data-next-head=""/><meta name="description" content="本文主要介绍使用rxjs和react实现一个经典的贪吃蛇游戏。" data-next-head=""/><meta property="og:title" content="暮天云光-rxjs实现贪吃蛇小游戏" data-next-head=""/><meta property="og:description" content="本文主要介绍使用rxjs和react实现一个经典的贪吃蛇游戏。" data-next-head=""/><meta name="keywords" content="rxjs,游戏,贪吃蛇" data-next-head=""/><link rel="shortcut icon" href="/favicon.ico?"/><link rel="preload" href="/_next/static/css/5546acd303353f69.css" as="style"/><link rel="preload" href="/_next/static/css/3f5b9e40b55cc87f.css" as="style"/><link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"/><script>window.__REACT_DEVTOOLS_GLOBAL_HOOK__.inject
                                =function(){}</script><script>
                                    window.dataLayer = window.dataLayer || [];
                                    function gtag(){dataLayer.push(arguments);}
                                    gtag('js', new Date());
                                    gtag('config', 'G-3DGNKE718G');
                                    </script><link rel="stylesheet" href="/_next/static/css/5546acd303353f69.css" data-n-g=""/><link rel="stylesheet" href="/_next/static/css/3f5b9e40b55cc87f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" noModule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6ffd07a3317375c1.js" defer=""></script><script src="/_next/static/chunks/framework-10ea8e61138a58ea.js" defer=""></script><script src="/_next/static/chunks/main-fcb13ce1ba122412.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c5879348fb3e202e.js" defer=""></script><script src="/_next/static/chunks/166-b07ac90dd3726f11.js" defer=""></script><script src="/_next/static/chunks/pages/article/%5Bid%5D-13bd4a108b3e972b.js" defer=""></script><script src="/_next/static/next-build/_buildManifest.js" defer=""></script><script src="/_next/static/next-build/_ssgManifest.js" defer=""></script></head><body><link rel="preload" as="image" href="https://user-images.githubusercontent.com/18588945/122550390-291dea00-d066-11eb-8077-2a827aeccc11.png"/><div id="__next"><nav class="navbar_navbar__DLtmj"><div class="navbar_containerFluid__mUw8m"><a class="navbar_navbarHeader__pD7He" href="/">暮天云光</a><ul class="navbar_nav__mA8Ko"><li><a href="/">HOME</a></li><li><a href="/about">关于</a></li><li><a href="/game">小游戏</a></li><li><a href="/archives">归档</a></li><li><a href="/tag">标签</a></li></ul><button class="navbar_navToggle__7O7ON" id="nav-toggle"><span class="navbar_iconBar__igEr6"></span><span class="navbar_iconBar__igEr6 navbar_mid__RikJj"></span><span class="navbar_iconBar__igEr6"></span></button></div></nav><header class="header_header__LUADv"><div class="container"><div class="column"><div class="content"><div class="header_articleHeading__TqTGo"><div class="header_tags__4xghr"><a href="/tag#react">react</a></div><h1>rxjs实现贪吃蛇小游戏</h1><span class="header_meta__L2LEO">Posted by gwl002 on <!-- -->2021-06-10</span></div></div></div></div></header><article><div class="container"><div class="column"><div class="content"><div class="article_article__HpMhr"><p>初识rxjs感觉惊奇，感觉很多复杂的逻辑好像用rxjs来写变得简单明了。断断续续得学习了一阵子，感觉很好，却一直没有真正在项目中使用过。学习而不使用过不了多久就会忘记，所以这次写一个小demo来加深一下印象。那么写什么好呢，想到以前用react写过贪吃蛇小游戏，据说rxjs很适合用来开发游戏类程序，所以决定用rxjs来写一个经典的贪吃蛇小游戏。</p>
<p>本文并不介绍rxjs原理和各种操作符的使用，主要解释一下实现的逻辑。
<a href="https://github.com/gwl002/rxjsSnakeGame">源码</a>
<a href="https://gwl002.github.io/game/greedySnake">demo展示</a>
推荐几个我经常学习的网站：</p>
<ul>
<li><a href="https://ithelp.ithome.com.tw/articles/10186103">30 天精通 RxJS (00)： 關於本系列文章</a> 台湾同胞早年写的教程，写的很好，从原理到使用都讲的很好，还有一些生动的例子，虽然版本和写法已经有些不同，但并不影响学习。</li>
<li><a href="https://rxjs.dev/">官网</a></li>
<li><a href="https://www.learnrxjs.io/">Learn Rxjs</a>很好的学习网站，每个操作符的解释和例子，以及各种demo。</li>
</ul>
<h1>实现UI</h1>
<p>首先看一下整体的界面，包括Board(蛇移动的范围)、Snake(红色）、Food(绿色)、Score(分数)、暂停和重置按钮。这里我们使用react来渲染视图，当然也可以用canvas，我们只注重于逻辑，不关心ui。我们采取数据驱动视图的思维开发，逻辑和页面元素是解耦合，这种思维可以让我们很轻松从react渲染切换到canvas渲染。</p>
<p><img src="https://user-images.githubusercontent.com/18588945/122550390-291dea00-d066-11eb-8077-2a827aeccc11.png" alt="image"/></p>
<h3>Board</h3>
<p>这个结构是基本不变的，只渲染一次就够了，当然把gameover移除更好，懂react的应该理解为什么用memo。</p>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable maybe-class-name" style="color:#c792ea">GameOver</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">{</span><span class="token token parameter"> isGameOver </span><span class="token token parameter" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">!</span><span>isGameOver</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token null nil" style="color:#c792ea;font-style:italic">null</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">h1</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">className</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">center</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">GAME OVER</span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">h1</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token maybe-class-name">Board</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">memo</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">{</span><span class="token token parameter"> winWidth</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> size</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isGameOver </span><span class="token token parameter" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> itemWidth </span><span class="token token" style="color:#89ddff">=</span><span> winWidth </span><span class="token token" style="color:#89ddff">/</span><span> size</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable maybe-class-name" style="color:#c792ea">Row</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">{</span><span class="token token parameter"> rowIndex </span><span class="token token parameter" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">className</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">rowContainer</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                    </span><span class="token token known-class-name" style="color:#f2ff00">Array</span><span class="token token" style="color:#89ddff">(</span><span>size</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">fill</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">item</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> index</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>                        </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">key</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">index</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">className</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">boardItem</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">style</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript literal-property" style="color:#f07178">width</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript literal-property" style="color:#f07178">height</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth </span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                            </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                        </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>                    </span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">}</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">id</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">board</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token known-class-name" style="color:#f2ff00">Array</span><span class="token token" style="color:#89ddff">(</span><span>size</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">fill</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">item</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> index</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f2ff00">Row</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">key</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">index</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#89ddff">/&gt;</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f2ff00">GameOver</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">isGameOver</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">isGameOver</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#89ddff">/&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">        </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
<h3>Snake 和 Food</h3>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable maybe-class-name" style="color:#c792ea">Food</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">{</span><span class="token token parameter"> food</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> itemWidth </span><span class="token token parameter" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">!</span><span>food</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token null nil" style="color:#c792ea;font-style:italic">null</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">            </span><span class="token token" style="color:#ffcb6b">className</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">boardItem</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">            </span><span class="token token" style="color:#ffcb6b">style</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                </span><span class="token token script language-javascript literal-property" style="color:#f07178">position</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#c3e88d">&quot;absolute&quot;</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                </span><span class="token token script language-javascript literal-property" style="color:#f07178">width</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                </span><span class="token token script language-javascript literal-property" style="color:#f07178">height</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                </span><span class="token token script language-javascript literal-property" style="color:#f07178">left</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth </span><span class="token token script language-javascript" style="color:#89ddff">*</span><span class="token token script language-javascript" style="color:#f07178"> food</span><span class="token token script language-javascript" style="color:#89ddff">.</span><span class="token token script language-javascript property-access" style="color:#f07178">x</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                </span><span class="token token script language-javascript literal-property" style="color:#f07178">top</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth </span><span class="token token script language-javascript" style="color:#89ddff">*</span><span class="token token script language-javascript" style="color:#f07178"> food</span><span class="token token script language-javascript" style="color:#89ddff">.</span><span class="token token script language-javascript property-access" style="color:#f07178">y</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                </span><span class="token token script language-javascript literal-property" style="color:#f07178">backgroundColor</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#c3e88d">&quot;green&quot;</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">            </span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">        </span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">        </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span></span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token maybe-class-name">Snake</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">memo</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">{</span><span class="token token parameter"> data</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> itemWidth </span><span class="token token parameter" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">{</span><span>data</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">item</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> index</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">                    </span><span class="token token" style="color:#546e7a">// key={`${item.x}-${item.y}`}</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">                    </span><span class="token token" style="color:#ffcb6b">key</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">index</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">                    </span><span class="token token" style="color:#ffcb6b">className</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">boardItem</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">                    </span><span class="token token" style="color:#ffcb6b">style</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                        </span><span class="token token script language-javascript literal-property" style="color:#f07178">position</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#c3e88d">&quot;absolute&quot;</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                        </span><span class="token token script language-javascript literal-property" style="color:#f07178">width</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                        </span><span class="token token script language-javascript literal-property" style="color:#f07178">height</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                        </span><span class="token token script language-javascript literal-property" style="color:#f07178">left</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth </span><span class="token token script language-javascript" style="color:#89ddff">*</span><span class="token token script language-javascript" style="color:#f07178"> item</span><span class="token token script language-javascript" style="color:#89ddff">.</span><span class="token token script language-javascript property-access" style="color:#f07178">x</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                        </span><span class="token token script language-javascript literal-property" style="color:#f07178">top</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> itemWidth </span><span class="token token script language-javascript" style="color:#89ddff">*</span><span class="token token script language-javascript" style="color:#f07178"> item</span><span class="token token script language-javascript" style="color:#89ddff">.</span><span class="token token script language-javascript property-access" style="color:#f07178">y</span><span class="token token script language-javascript" style="color:#89ddff">,</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                        </span><span class="token token script language-javascript literal-property" style="color:#f07178">backgroundColor</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#c3e88d">&quot;red&quot;</span><span class="token token script language-javascript" style="color:#f07178">
</span><span class="token token script language-javascript" style="color:#f07178">                    </span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178">
</span><span class="token token" style="color:#f07178">                </span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                    </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">}</span><span class="token token plain-text">
</span><span class="token token plain-text">        </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
<h3>App</h3>
<p>把各个组件整合起来</p>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable maybe-class-name" style="color:#c792ea">App</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> size </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#fd9170">20</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>ref</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">{</span><span> width </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">useMeasure</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> itemWidth </span><span class="token token" style="color:#89ddff">=</span><span> width </span><span class="token token" style="color:#89ddff">/</span><span> size</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> initialState </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">isGameOver</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c792ea">false</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">score</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">snake</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>
</span>
<span>        </span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">food</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token null nil" style="color:#c792ea;font-style:italic">null</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">isPaused</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c792ea">true</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>state</span><span class="token token" style="color:#89ddff">,</span><span> setState</span><span class="token token" style="color:#89ddff">]</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">useState</span><span class="token token" style="color:#89ddff">(</span><span>initialState</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">renderGame</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isPaused</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> food</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> score</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isGameOver</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">setState</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">state</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token spread" style="color:#89ddff">...</span><span>state</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                snake</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                isPaused</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                food</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                score</span><span class="token token" style="color:#89ddff">,</span><span>
</span>                isGameOver
<span>            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f2ff00">Head</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">link</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">rel</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">stylesheet</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">href</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">/styles/greedySnake.css</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#89ddff">/&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f2ff00">Head</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">{</span><span>width </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token null nil" style="color:#c792ea;font-style:italic">null</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f2ff00">Loading</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#89ddff">/&gt;</span><span class="token token" style="color:#89ddff">}</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">className</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">snakeGame</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">ref</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">ref</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">style</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript literal-property" style="color:#f07178">visibility</span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> width </span><span class="token token script language-javascript" style="color:#89ddff">&gt;</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#fd9170">0</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#89ddff">?</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#c3e88d">&quot;visible&quot;</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#89ddff">:</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#c3e88d">&quot;hidden&quot;</span><span class="token token script language-javascript" style="color:#f07178"> </span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f2ff00">Board</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">winWidth</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">width</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">size</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">size</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">isGameOver</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">state</span><span class="token token script language-javascript" style="color:#89ddff">.</span><span class="token token script language-javascript property-access" style="color:#f07178">isGameOver</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#89ddff">/&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f2ff00">Snake</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">itemWidth</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">itemWidth</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">data</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">state</span><span class="token token script language-javascript" style="color:#89ddff">.</span><span class="token token script language-javascript property-access" style="color:#f07178">snake</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#89ddff">/&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f2ff00">Food</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">itemWidth</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">itemWidth</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">food</span><span class="token token script language-javascript script-punctuation" style="color:#f07178">=</span><span class="token token script language-javascript" style="color:#89ddff">{</span><span class="token token script language-javascript" style="color:#f07178">state</span><span class="token token script language-javascript" style="color:#89ddff">.</span><span class="token token script language-javascript property-access" style="color:#f07178">food</span><span class="token token script language-javascript" style="color:#89ddff">}</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#89ddff">/&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                    </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">button</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">id</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">pauseORresume</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                        state</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">isPaused</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#c3e88d">&quot;START&quot;</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&quot;PAUSE&quot;</span><span>
</span><span>                    </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">button</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                    </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">button</span><span class="token token" style="color:#f07178"> </span><span class="token token" style="color:#ffcb6b">id</span><span class="token token attr-equals" style="color:#89ddff">=</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#c3e88d">reset</span><span class="token token" style="color:#89ddff">&quot;</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">reset</span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">button</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">                </span><span class="token token" style="color:#89ddff">&lt;</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token" style="color:#89ddff">{</span><span>state</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">score</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">span</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">            </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#f07178">div</span><span class="token token" style="color:#89ddff">&gt;</span><span class="token token plain-text">
</span><span class="token token plain-text">        </span><span class="token token" style="color:#89ddff">&lt;/</span><span class="token token" style="color:#89ddff">&gt;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span></code></div></pre>
<p>现在我们已经实现了基本的页面，接下来我们要做的写游戏的逻辑驱动各元素动起来。</p>
<h1>实现游戏的逻辑</h1>
<h3>逻辑总体分析</h3>
<p>首先我们分析renderGame方法，可以看到我们需要snake、food、isPaused、isGameover、score5个值来描述游戏的当前状态。那么我们设立5个流snake$、food$、isPaused$、isGameover$、score$来描述这5个状态，这5个流任何一个更新我们就重刷游戏的状态。那么现在我们的代码看起来应该是这样的。这里我们使用combineLast来获取每个流的最新值，不懂combineLast的可以先去官网看看教程。rxjs的操作符确实博大精深，一个操作符就能实现一个功能，组合起来更加精妙。</p>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> snake$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">of</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> food$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">of</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">4</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">4</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> isPaused$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">of</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> isGameOver$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">of</span><span class="token token" style="color:#89ddff">(</span><span>falsse</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> score$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">of</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> game$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">combineLatest</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">[</span><span>snake$</span><span class="token token" style="color:#89ddff">,</span><span> pause$</span><span class="token token" style="color:#89ddff">,</span><span> food$</span><span class="token token" style="color:#89ddff">,</span><span> score$</span><span class="token token" style="color:#89ddff">,</span><span> gameOver$</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">takeWhile</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isPaused</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> food</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> score</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isGameOver</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">!</span><span>isGameOver</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea">useEffect</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> sub </span><span class="token token" style="color:#89ddff">=</span><span> game$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">subscribe</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">game</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">renderGame</span><span class="token token" style="color:#89ddff">(</span><span>game</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        sub</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">unsubcribe</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span></span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
<h3>实现snake$</h3>
<ol>
<li>让蛇动起来
首先我们让蛇动起来，很容易就想到interval用每隔一定时间发送一个值然后更新snake$，这里通过一个scan操作符记录上次的结果。scan和reduce很像，只是它处理的不是数组而是一个流。现在每秒发送一个值，然后snake更新x坐标加1，y坐标不变，相当于蛇向右边移动。</li>
</ol>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> snake$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">interval</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1000</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">_</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token" style="color:#546e7a">//现在我们假设🐍的方向是向右</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> head </span><span class="token token" style="color:#89ddff">=</span><span> snake</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span>_y</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            _x </span><span class="token token" style="color:#89ddff">=</span><span> head</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">+</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            _y </span><span class="token token" style="color:#89ddff">=</span><span> head</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span>_x</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span>_y</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
<ol start="2">
<li>控制蛇的方向
现在蛇可以动了，我们要控制它的方向，通过监听键盘上下左右键，控制蛇的下一个位置.我们加入一个新的流dir$,并更新snake$。再次强调我们不解释各种操作符的用法，请看注释或者自行学习。</li>
</ol>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>
</span><span>        </span><span class="token token" style="color:#c3e88d">&quot;ArrowUp&quot;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#c3e88d">&quot;ArrowDown&quot;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#c3e88d">&quot;ArrowLeft&quot;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">]</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token" style="color:#c792ea">KEY_OPPOSITE</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">ArrowUp</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowDown&quot;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">ArrowDown</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowUp&quot;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">ArrowRight</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowLeft&quot;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token literal-property" style="color:#80cbc4">ArrowLeft</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> dir$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;keydown&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">pluck</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;key&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#546e7a">//从event中取出key</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">filter</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">key</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">includes</span><span class="token token" style="color:#89ddff">(</span><span>key</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#546e7a">//过滤掉不是方向键的event</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#546e7a">//设置初始方向</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">distinctUntilChanged</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>  </span><span class="token token" style="color:#546e7a">//同一个键盘连续2次不会重复发送</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> snake$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">interval</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1000</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">withLastFrom</span><span class="token token" style="color:#89ddff">(</span><span>dir$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>  </span><span class="token token" style="color:#546e7a">//每次interval都去取dir的最新值 </span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">_</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">dir</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> head </span><span class="token token" style="color:#89ddff">=</span><span> snake</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span>_y</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">switch</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>dir</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowLeft&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowUp&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowDown&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span>_x</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span>_y</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
<p>现在我们可以通过鼠标控制蛇上下左右自由的移动了。但是我希望在手机上也能玩，可以通过监听touch事件实现。所以我们再加一个手势判断的流gestureDir$。读者应该可以看出现在我们代码逻辑很清晰，一个个简单的功能组成最终的功能，各自完成自己的工作。这就是rxjs的强大之处。想一下我们现在不用rxjs，要实现一个dir$的功能，感觉有一大堆代码要写，而且很散乱，没有一定的功力很难写的很漂亮逻辑这么清晰。</p>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>     </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> keyDir$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;keydown&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>         </span><span class="token token" style="color:#c792ea">pluck</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;key&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>         </span><span class="token token" style="color:#c792ea">filter</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">key</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">includes</span><span class="token token" style="color:#89ddff">(</span><span>key</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>         </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>         </span><span class="token token" style="color:#c792ea">distinctUntilChanged</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>     </span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">gestureDir$</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">function</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;ontouchstart&#x27;</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">in</span><span> </span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">documentElement</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;touchstart&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea">switchMap</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">startEvent</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span>
</span><span>                    </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;touchmove&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>                        </span><span class="token token" style="color:#c792ea">takeUntil</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;touchend&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                        </span><span class="token token" style="color:#c792ea">takeLast</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                        </span><span class="token token" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">event</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> deltaX </span><span class="token token" style="color:#89ddff">=</span><span> event</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageX</span><span> </span><span class="token token" style="color:#89ddff">-</span><span> startEvent</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageX</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> deltaY </span><span class="token token" style="color:#89ddff">=</span><span> event</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageY</span><span> </span><span class="token token" style="color:#89ddff">-</span><span> startEvent</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageY</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>deltaX </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaX</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaY</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">3</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                            </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>deltaX </span><span class="token token" style="color:#89ddff">&lt;</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaX</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaY</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">2</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                            </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>deltaY </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaY</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaX</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                            </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span>
</span><span>                            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>                        </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                    </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">NEVER</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> dir$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">merge</span><span class="token token" style="color:#89ddff">(</span><span>keyDir$</span><span class="token token" style="color:#89ddff">,</span><span> gestureDir$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>    </code></div></pre>
<ol start="3">
<li>让蛇吃苹果变长
现在蛇可以控制方向4处移动了，但是还不能变长，我们要实现在蛇吃到苹果时长度增加1并且苹果的位置改变。这里有点复杂，因为snake$和food$相互关联了起来。snake$需要拿到当前food$的值来判断是否吃到🍎而food$也需要拿到snake的值来生成新的位置但不要和snake的位置重叠。我们引入一个新的流eatFood$来通知food$。
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>
</span><span> </span><span class="token token" style="color:#546e7a">//随机生成食物</span><span>
</span><span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">createFood</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">size</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> data</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>     </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> x </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">floor</span><span class="token token" style="color:#89ddff">(</span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">random</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> size</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>     </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> y </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">floor</span><span class="token token" style="color:#89ddff">(</span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">random</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">*</span><span> size</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>     </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>data</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">some</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">item</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> item</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> x </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> item</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> y</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>         </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">createFood</span><span class="token token" style="color:#89ddff">(</span><span>size</span><span class="token token" style="color:#89ddff">,</span><span> data</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>     </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>     </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">{</span><span> x</span><span class="token token" style="color:#89ddff">,</span><span> y </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span> </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span> </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> eatFood$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">new</span><span> </span><span class="token token" style="color:#f2ff00">BehaviorSubject</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span> </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> food$ </span><span class="token token" style="color:#89ddff">=</span><span> eatFood$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>     </span><span class="token token" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">createFood</span><span class="token token" style="color:#89ddff">(</span><span>size</span><span class="token token" style="color:#89ddff">,</span><span> snake</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>     </span><span class="token token" style="color:#c792ea">shareReplay</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#546e7a">//为什么要用shareReplay?</span><span>
</span><span> </span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span> </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> snake$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">interval</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1000</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>     </span><span class="token token" style="color:#c792ea">withLastFrom</span><span class="token token" style="color:#89ddff">(</span><span>dir$</span><span class="token token" style="color:#89ddff">,</span><span>food$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>  </span><span class="token token" style="color:#546e7a">//每次interval都去取dir的最新值 </span><span>
</span><span>     </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">_</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">dir</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">food</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>         </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> head </span><span class="token token" style="color:#89ddff">=</span><span> snake</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>         </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span>_y</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>         </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">switch</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>dir</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>             </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                 _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                 </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>             </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowLeft&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                 _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                 </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>             </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowUp&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                 _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                 </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>             </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowDown&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                 _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                 </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>         </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>         snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">unshift</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">{</span><span> </span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>             </span><span class="token token" style="color:#546e7a">//吃到🍎,通知更新food$</span><span>
</span><span>         </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _x </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _y</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>             eatFood$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">next</span><span class="token token" style="color:#89ddff">(</span><span>snake</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#546e7a">//通知food$更新</span><span>
</span><span>         </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>             snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pop</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>         </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>         </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token spread" style="color:#89ddff">...</span><span>snake</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>     </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span> </span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
</li>
<li>增加暂停功能
现在蛇已经能自由移动，通过吃🍎不断的变长了，游戏的基本逻辑已经实现。接下来我们增加一个暂停和恢复的功能。请注意看pause实现，我们通过switchMap操作符来控制是否往下面的流发送值。
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> pauseClick$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">getElementById</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;pauseORresume&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;click&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> pauseKey$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;keydown&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">pluck</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;code&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">filter</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">code</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> code </span><span class="token token" style="color:#89ddff">===</span><span> </span><span class="token token" style="color:#c3e88d">&quot;Space&quot;</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> pause$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">merge</span><span class="token token" style="color:#89ddff">(</span><span>pauseClick$</span><span class="token token" style="color:#89ddff">,</span><span> pauseKey$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">current</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> prev</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> current </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#c792ea">false</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c792ea">false</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> interval$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">interval</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">200</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span></span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> snake$ </span><span class="token token" style="color:#89ddff">=</span><span> pause$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">switchMap</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">isPaused</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> isPaused </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#c792ea">NEVER</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> inteval$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;init&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">withLastFrom</span><span class="token token" style="color:#89ddff">(</span><span>dir$</span><span class="token token" style="color:#89ddff">,</span><span>food$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>  </span><span class="token token" style="color:#546e7a">//每次interval都去取dir的最新值 </span><span>
</span><span>    </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">_</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">dir</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">food</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> head </span><span class="token token" style="color:#89ddff">=</span><span> snake</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span>_y</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">switch</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>dir</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowLeft&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowUp&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowDown&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>        snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">unshift</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">{</span><span> </span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#546e7a">//吃到🍎,通知更新food$</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _x </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _y</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            eatFood$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">next</span><span class="token token" style="color:#89ddff">(</span><span>snake</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#546e7a">//通知food$更新</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pop</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token spread" style="color:#89ddff">...</span><span>snake</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span></span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
</li>
<li>增加gameover判断
现在游戏逻辑基本完成，但是什么时候游戏结束呢，我们还需要实现isGameOver$的逻辑，当蛇咬到自己的时候游戏结束，在snake$里做判断就行。</li>
</ol>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">checkGameOver</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> head </span><span class="token token" style="color:#89ddff">=</span><span> snake</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">slice</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">some</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">item</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> item</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> head</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> item</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span> </span><span class="token token" style="color:#89ddff">===</span><span>  head</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> snake$ </span><span class="token token" style="color:#89ddff">=</span><span> pause$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">switchMap</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">isPaused</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> isPaused </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#c792ea">NEVER</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> inteval$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;init&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">withLastFrom</span><span class="token token" style="color:#89ddff">(</span><span>dir$</span><span class="token token" style="color:#89ddff">,</span><span>food$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>  </span><span class="token token" style="color:#546e7a">//每次interval都去取dir的最新值 </span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">_</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">dir</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter">food</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> head </span><span class="token token" style="color:#89ddff">=</span><span> snake</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span>_y</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">switch</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>dir</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowLeft&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowUp&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowDown&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                    _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>            snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">unshift</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">{</span><span> </span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#546e7a">//吃到🍎,通知更新food$</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _x </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _y</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                eatFood$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">next</span><span class="token token" style="color:#89ddff">(</span><span>snake</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#546e7a">//通知food$更新</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pop</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">checkGameOver</span><span class="token token" style="color:#89ddff">(</span><span>snake</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                gameOver$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">next</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token spread" style="color:#89ddff">...</span><span>snake</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">,</span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">)</span><span>
</span></code></div></pre>
<ol start="6">
<li>增加reset功能
游戏结束时我们还需要重置游戏的功能。我们先把之前的逻辑整理成一个方法createGame，然后再增加一个startGame的方法，每次reset就重建一个game$达到reset的作用。最终代码如下：</li>
</ol>
<pre><div style="text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;overflow:auto;position:relative;margin:0.5em 0;padding:1.25em 1em"><code class="language-jsx" style="white-space:pre;text-align:left;word-spacing:normal;word-break:normal;word-wrap:normal;color:#c3cee3;background:#263238;font-family:Roboto Mono, monospace;font-size:1em;line-height:1.5em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">createGame</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> gameOver$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">new</span><span> </span><span class="token token" style="color:#f2ff00">BehaviorSubject</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">false</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> keyDir$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;keydown&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">pluck</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;key&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">filter</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">key</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">includes</span><span class="token token" style="color:#89ddff">(</span><span>key</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">distinctUntilChanged</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">gestureDir$</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">function</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&#x27;ontouchstart&#x27;</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">in</span><span> </span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">documentElement</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;touchstart&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>                    </span><span class="token token" style="color:#c792ea">switchMap</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">startEvent</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span>
</span><span>                        </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;touchmove&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>                            </span><span class="token token" style="color:#c792ea">takeUntil</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;touchend&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                            </span><span class="token token" style="color:#c792ea">takeLast</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                            </span><span class="token token" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">event</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> deltaX </span><span class="token token" style="color:#89ddff">=</span><span> event</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageX</span><span> </span><span class="token token" style="color:#89ddff">-</span><span> startEvent</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageX</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                                </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> deltaY </span><span class="token token" style="color:#89ddff">=</span><span> event</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageY</span><span> </span><span class="token token" style="color:#89ddff">-</span><span> startEvent</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">touches</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">pageY</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>deltaX </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaX</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaY</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">3</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                                </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>deltaX </span><span class="token token" style="color:#89ddff">&lt;</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaX</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaY</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">2</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                                </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>deltaY </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaY</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">&gt;</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">abs</span><span class="token token" style="color:#89ddff">(</span><span>deltaX</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                                </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">KEY_EVENTS_DIR</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span>
</span><span>                                </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>                            </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                        </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>                    </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">NEVER</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<!-- -->
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> dir$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">merge</span><span class="token token" style="color:#89ddff">(</span><span>keyDir$</span><span class="token token" style="color:#89ddff">,</span><span> gestureDir$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> pauseClick$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">getElementById</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;pauseORresume&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;click&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> pauseKey$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;keydown&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">pluck</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;code&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">filter</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">code</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> code </span><span class="token token" style="color:#89ddff">===</span><span> </span><span class="token token" style="color:#c3e88d">&quot;Space&quot;</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> pause$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">merge</span><span class="token token" style="color:#89ddff">(</span><span>pauseClick$</span><span class="token token" style="color:#89ddff">,</span><span> pauseKey$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">current</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> prev</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> current </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#c792ea">false</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c792ea">false</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> eatFood$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea;font-style:italic">new</span><span> </span><span class="token token" style="color:#f2ff00">BehaviorSubject</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> score$ </span><span class="token token" style="color:#89ddff">=</span><span> eatFood$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">score</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> _</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> score </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">-</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> food$ </span><span class="token token" style="color:#89ddff">=</span><span> eatFood$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">createFood</span><span class="token token" style="color:#89ddff">(</span><span>size</span><span class="token token" style="color:#89ddff">,</span><span> snake</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">shareReplay</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span>        </span><span class="token token" style="color:#546e7a">//增加小需求每吃5个苹果速度增加</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> inteval$ </span><span class="token token" style="color:#89ddff">=</span><span> score$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">filter</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">score</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> score </span><span class="token token" style="color:#89ddff">%</span><span> </span><span class="token token" style="color:#fd9170">5</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> </span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">map</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">score</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> level </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token known-class-name" style="color:#f2ff00">Math</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">floor</span><span class="token token" style="color:#89ddff">(</span><span>score </span><span class="token token" style="color:#89ddff">/</span><span> </span><span class="token token" style="color:#fd9170">5</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                level </span><span class="token token" style="color:#89ddff">=</span><span> level </span><span class="token token" style="color:#89ddff">&gt;=</span><span> </span><span class="token token" style="color:#fd9170">3</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">3</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> level</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#c792ea">INTERVAL_TIMES</span><span class="token token" style="color:#89ddff">[</span><span>level</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">distinctUntilChanged</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">switchMap</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">time</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">interval</span><span class="token token" style="color:#89ddff">(</span><span>time</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> snake$ </span><span class="token token" style="color:#89ddff">=</span><span> pause$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">switchMap</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">isPaused</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> isPaused </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#c792ea">NEVER</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> inteval$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">startWith</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;init&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">withLatestFrom</span><span class="token token" style="color:#89ddff">(</span><span>dir$</span><span class="token token" style="color:#89ddff">,</span><span> food$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#546e7a">//快速切换相反方向导致蛇吃到自己</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">prev</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> </span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">_</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> dir</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> food</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">KEY_OPPOSITE</span><span class="token token" style="color:#89ddff">[</span><span>dir</span><span class="token token" style="color:#89ddff">]</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> prev</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                    </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>prev</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">,</span><span> food</span><span class="token token" style="color:#89ddff">]</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span>dir</span><span class="token token" style="color:#89ddff">,</span><span> food</span><span class="token token" style="color:#89ddff">]</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">scan</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> </span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">dir</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> food</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> head </span><span class="token token" style="color:#89ddff">=</span><span> snake</span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#fd9170">0</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> _x </span><span class="token token" style="color:#89ddff">=</span><span> head</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> _y </span><span class="token token" style="color:#89ddff">=</span><span> head</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">switch</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>dir</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                    </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowRight&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                        _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowLeft&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                        _x </span><span class="token token" style="color:#89ddff">=</span><span> _x </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _x </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowUp&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                        _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&lt;=</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                    </span><span class="token token" style="color:#c792ea;font-style:italic">case</span><span> </span><span class="token token" style="color:#c3e88d">&quot;ArrowDown&quot;</span><span class="token token" style="color:#89ddff">:</span><span>
</span><span>                        _y </span><span class="token token" style="color:#89ddff">=</span><span> _y </span><span class="token token" style="color:#89ddff">&gt;=</span><span> size </span><span class="token token" style="color:#89ddff">-</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">?</span><span> </span><span class="token token" style="color:#fd9170">0</span><span> </span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">+</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">break</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>                snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">unshift</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">{</span><span> </span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span> _x</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span> _y </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#546e7a">//吃到🍎,通知更新food$</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span>food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">x</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _x </span><span class="token token" style="color:#89ddff">&amp;&amp;</span><span> food</span><span class="token token" style="color:#89ddff">.</span><span class="token token property-access">y</span><span> </span><span class="token token" style="color:#89ddff">===</span><span> _y</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                    eatFood$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">next</span><span class="token token" style="color:#89ddff">(</span><span>snake</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">}</span><span> </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">else</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                    snake</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pop</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">if</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">checkGameOver</span><span class="token token" style="color:#89ddff">(</span><span>snake</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                    gameOver$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">next</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>                </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>                </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token spread" style="color:#89ddff">...</span><span>snake</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>            </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">{</span><span> </span><span class="token token literal-property" style="color:#80cbc4">x</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#fd9170">1</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token literal-property" style="color:#80cbc4">y</span><span class="token token" style="color:#89ddff">:</span><span> </span><span class="token token" style="color:#fd9170">1</span><span> </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> game$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">combineLatest</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">[</span><span>snake$</span><span class="token token" style="color:#89ddff">,</span><span> pause$</span><span class="token token" style="color:#89ddff">,</span><span> food$</span><span class="token token" style="color:#89ddff">,</span><span> score$</span><span class="token token" style="color:#89ddff">,</span><span> gameOver$</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">takeWhile</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isPaused</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> food</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> score</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isGameOver</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">!</span><span>isGameOver</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c792ea">true</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> game$</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<!-- -->
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">renderGame</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter" style="color:#89ddff">[</span><span class="token token parameter">snake</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isPaused</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> food</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> score</span><span class="token token parameter" style="color:#89ddff">,</span><span class="token token parameter"> isGameOver</span><span class="token token parameter" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea">setState</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">state</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>                </span><span class="token token spread" style="color:#89ddff">...</span><span>state</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                snake</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                isPaused</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                food</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>                score</span><span class="token token" style="color:#89ddff">,</span><span>
</span>                isGameOver
<span>            </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> </span><span class="token token function-variable" style="color:#c792ea">startGame</span><span> </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> reset$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">fromEvent</span><span class="token token" style="color:#89ddff">(</span><span class="token token dom" style="color:#f07178">document</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">getElementById</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;reset&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#c3e88d">&quot;click&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> game$ </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">merge</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c792ea;font-style:italic">of</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#c3e88d">&quot;startGame&quot;</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span> reset$</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">pipe</span><span class="token token" style="color:#89ddff">(</span><span>
</span><span>            </span><span class="token token" style="color:#c792ea">switchMap</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">x</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">createGame</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">,</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">const</span><span> sub </span><span class="token token" style="color:#89ddff">=</span><span> game$</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">subscribe</span><span class="token token" style="color:#89ddff">(</span><span class="token token parameter">game</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#c792ea">renderGame</span><span class="token token" style="color:#89ddff">(</span><span>game</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">)</span><span>
</span><span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> sub</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span>
</span>
<span>    </span><span class="token token" style="color:#c792ea">useEffect</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>        </span><span class="token token" style="color:#c792ea;font-style:italic">let</span><span> sub </span><span class="token token" style="color:#89ddff">=</span><span> </span><span class="token token" style="color:#c792ea">startGame</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span>
<span>        </span><span class="token token control-flow" style="color:#c792ea;font-style:italic">return</span><span> </span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span> </span><span class="token token arrow" style="color:#89ddff">=&gt;</span><span> </span><span class="token token" style="color:#89ddff">{</span><span>
</span><span>            sub</span><span class="token token" style="color:#89ddff">.</span><span class="token token method property-access" style="color:#c792ea">unsubscribe</span><span class="token token" style="color:#89ddff">(</span><span class="token token" style="color:#89ddff">)</span><span class="token token" style="color:#89ddff">;</span><span>
</span><span>        </span><span class="token token" style="color:#89ddff">}</span><span>
</span><span>    </span><span class="token token" style="color:#89ddff">}</span><span class="token token" style="color:#89ddff">,</span><span> </span><span class="token token" style="color:#89ddff">[</span><span class="token token" style="color:#89ddff">]</span><span class="token token" style="color:#89ddff">)</span></code></div></pre>
<h1>总结</h1>
<p>通过写一个贪吃蛇游戏确实加深了我对rxjs的理解，之前我也以为我差不多懂rxjs的用法了。但是真正写的时候为了实现各种需求还是遇到了很多问题。以我写这个demo的经验来看，rxjs真的没有说的那么简单，为了实现不同功能在不同的流之间穿插很考验你对rxjs真正理解的程度。但是不得不承认rxjs真的强大，通过组合各种简单方法实现一个复杂的功能，代码思路清晰逻辑分明，容易扩展和维护。那么到底要不要用rxjs呢?我的观点是一定要比较深入理解rxjs了再用，不然你会遇到很多麻烦的。rxjs可能不像react一样简单，随便看看文档懂了jsx和生命周期就可以动手写了。</p><hr/></div><strong class="article_remark__Za7XM"><a href="https://github.com/gwl002/gwl002.github.io/issues/3">在github上参与本文讨论</a></strong><div class="home_sidebar__Oqqk_"><section><h5><a href="/tags">FEATURED TAGS</a></h5><ul><li class="home_tag__YZjS0"><a href="/tag#react">react</a></li></ul></section></div></div></div></div></article><footer class="footer_footer__YtHeK"><div class="footer_copywriting__6tSKT"><p>Copyright © 暮天云光 <!-- -->2025</p><p><span>Posted by  <a href="https://github.com/gwl002" target="_blank" rel="noopener noreferrer">gwl002</a></span><span> | 订阅本站<iframe style="margin-left:2px;margin-bottom:-5px" frameBorder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=gwl002&amp;repo=gwl002.github.io&amp;type=star&amp;count=false"></iframe></span></p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"a545cc6f56f33512f79047fdad298b65","title":"rxjs实现贪吃蛇小游戏","body":"初识rxjs感觉惊奇，感觉很多复杂的逻辑好像用rxjs来写变得简单明了。断断续续得学习了一阵子，感觉很好，却一直没有真正在项目中使用过。学习而不使用过不了多久就会忘记，所以这次写一个小demo来加深一下印象。那么写什么好呢，想到以前用react写过贪吃蛇小游戏，据说rxjs很适合用来开发游戏类程序，所以决定用rxjs来写一个经典的贪吃蛇小游戏。\r\n\r\n本文并不介绍rxjs原理和各种操作符的使用，主要解释一下实现的逻辑。\r\n[源码](https://github.com/gwl002/rxjsSnakeGame)\r\n[demo展示](https://gwl002.github.io/game/greedySnake)\r\n推荐几个我经常学习的网站：\r\n\r\n- [30 天精通 RxJS (00)： 關於本系列文章](https://ithelp.ithome.com.tw/articles/10186103) 台湾同胞早年写的教程，写的很好，从原理到使用都讲的很好，还有一些生动的例子，虽然版本和写法已经有些不同，但并不影响学习。\r\n- [官网](https://rxjs.dev/)\r\n- [Learn Rxjs](https://www.learnrxjs.io/)很好的学习网站，每个操作符的解释和例子，以及各种demo。\r\n\r\n# 实现UI\r\n首先看一下整体的界面，包括Board(蛇移动的范围)、Snake(红色）、Food(绿色)、Score(分数)、暂停和重置按钮。这里我们使用react来渲染视图，当然也可以用canvas，我们只注重于逻辑，不关心ui。我们采取数据驱动视图的思维开发，逻辑和页面元素是解耦合，这种思维可以让我们很轻松从react渲染切换到canvas渲染。\r\n\r\n![image](https://user-images.githubusercontent.com/18588945/122550390-291dea00-d066-11eb-8077-2a827aeccc11.png)\r\n\r\n### Board \r\n这个结构是基本不变的，只渲染一次就够了，当然把gameover移除更好，懂react的应该理解为什么用memo。\r\n```jsx\r\n\r\nconst GameOver = ({ isGameOver }) =\u003e {\r\n    if (!isGameOver) return null;\r\n    return (\r\n        \u003ch1 className=\"center\"\u003eGAME OVER\u003c/h1\u003e\r\n    )\r\n}\r\n\r\nconst Board = memo(({ winWidth, size, isGameOver }) =\u003e {\r\n    const itemWidth = winWidth / size;\r\n\r\n    const Row = ({ rowIndex }) =\u003e {\r\n        return (\r\n            \u003cdiv className=\"rowContainer\"\u003e\r\n                {\r\n                    Array(size).fill().map((item, index) =\u003e (\r\n                        \u003cspan key={index} className=\"boardItem\" style={{ width: itemWidth, height: itemWidth }}\u003e\r\n                            \u003cspan\u003e\u003c/span\u003e\r\n                        \u003c/span\u003e\r\n                    ))\r\n                }\r\n            \u003c/div\u003e\r\n        )\r\n    }\r\n\r\n    return (\r\n        \u003cdiv id=\"board\"\u003e\r\n            {\r\n                Array(size).fill().map((item, index) =\u003e \u003cRow key={index} /\u003e)\r\n            }\r\n            \u003cGameOver isGameOver={isGameOver} /\u003e\r\n        \u003c/div\u003e\r\n    )\r\n})\r\n```\r\n### Snake 和 Food\r\n```jsx\r\nconst Food = ({ food, itemWidth }) =\u003e {\r\n    if (!food) return null;\r\n\r\n    return (\r\n        \u003cspan\r\n            className=\"boardItem\"\r\n            style={{\r\n                position: \"absolute\",\r\n                width: itemWidth,\r\n                height: itemWidth,\r\n                left: itemWidth * food.x,\r\n                top: itemWidth * food.y,\r\n                backgroundColor: \"green\"\r\n            }}\r\n        \u003e\r\n            \u003cspan\u003e\u003c/span\u003e\r\n        \u003c/span\u003e\r\n    )\r\n\r\n}\r\n\r\nconst Snake = memo(({ data, itemWidth }) =\u003e {\r\n    return (\r\n        \u003c\u003e\r\n            {data.map((item, index) =\u003e\r\n                \u003cspan\r\n                    // key={`${item.x}-${item.y}`}\r\n                    key={index}\r\n                    className=\"boardItem\"\r\n                    style={{\r\n                        position: \"absolute\",\r\n                        width: itemWidth,\r\n                        height: itemWidth,\r\n                        left: itemWidth * item.x,\r\n                        top: itemWidth * item.y,\r\n                        backgroundColor: \"red\"\r\n                    }}\r\n                \u003e\r\n                    \u003cspan\u003e\u003c/span\u003e\r\n                \u003c/span\u003e\r\n            )}\r\n        \u003c/\u003e\r\n    )\r\n})\r\n```\r\n### App\r\n把各个组件整合起来\r\n```jsx\r\nconst App = () =\u003e {\r\n    const size = 20;\r\n    const [ref, { width }] = useMeasure();\r\n\r\n    const itemWidth = width / size;\r\n\r\n    const initialState = {\r\n        isGameOver: false,\r\n        score: 0,\r\n        snake: [\r\n\r\n        ],\r\n        food: null,\r\n        isPaused: true\r\n    }\r\n\r\n    const [state, setState] = useState(initialState);\r\n\r\n    const renderGame = ([snake, isPaused, food, score, isGameOver]) =\u003e {\r\n        setState(state =\u003e {\r\n            return {\r\n                ...state,\r\n                snake,\r\n                isPaused,\r\n                food,\r\n                score,\r\n                isGameOver\r\n            }\r\n        })\r\n    }\r\n\r\n    return (\r\n        \u003c\u003e\r\n            \u003cHead\u003e\r\n                \u003clink rel=\"stylesheet\" href=\"/styles/greedySnake.css\" /\u003e\r\n            \u003c/Head\u003e\r\n            {width \u003e 0 ? null : \u003cLoading /\u003e}\r\n            \u003cdiv className=\"snakeGame\" ref={ref} style={{ visibility: width \u003e 0 ? \"visible\" : \"hidden\" }}\u003e\r\n                \u003cBoard winWidth={width} size={size} isGameOver={state.isGameOver} /\u003e\r\n                \u003cSnake itemWidth={itemWidth} data={state.snake} /\u003e\r\n                \u003cFood itemWidth={itemWidth} food={state.food} /\u003e\r\n                \u003cdiv\u003e\r\n                    \u003cbutton id=\"pauseORresume\"\u003e{\r\n                        state.isPaused ? \"START\" : \"PAUSE\"\r\n                    }\u003c/button\u003e\r\n                \u003c/div\u003e\r\n                \u003cdiv\u003e\r\n                    \u003cbutton id=\"reset\"\u003ereset\u003c/button\u003e\r\n                \u003c/div\u003e\r\n                \u003cspan\u003e{state.score}\u003c/span\u003e\r\n            \u003c/div\u003e\r\n        \u003c/\u003e\r\n    )\r\n}\r\n```\r\n现在我们已经实现了基本的页面，接下来我们要做的写游戏的逻辑驱动各元素动起来。\r\n\r\n# 实现游戏的逻辑\r\n\r\n### 逻辑总体分析\r\n首先我们分析renderGame方法，可以看到我们需要snake、food、isPaused、isGameover、score5个值来描述游戏的当前状态。那么我们设立5个流snake\\$、food\\$、isPaused\\$、isGameover\\$、score\\$来描述这5个状态，这5个流任何一个更新我们就重刷游戏的状态。那么现在我们的代码看起来应该是这样的。这里我们使用combineLast来获取每个流的最新值，不懂combineLast的可以先去官网看看教程。rxjs的操作符确实博大精深，一个操作符就能实现一个功能，组合起来更加精妙。\r\n```jsx\r\nconst snake$ = of([{x:1,y:1}])\r\nconst food$ = of([{x:4,y:4}])\r\nconst isPaused$ = of(true)\r\nconst isGameOver$ = of(falsse)\r\nconst score$ = of(0)\r\n\r\nconst game$ = combineLatest([snake$, pause$, food$, score$, gameOver$]).pipe(\r\n            takeWhile(([snake, isPaused, food, score, isGameOver]) =\u003e !isGameOver, true)\r\n        )\r\n\r\nuseEffect(()=\u003e{\r\n    const sub = game$.subscribe(game =\u003e renderGame(game))\r\n    return () =\u003e {\r\n        sub.unsubcribe();\r\n    }\r\n})\r\n```\r\n### 实现snake$\r\n\r\n1. 让蛇动起来\r\n首先我们让蛇动起来，很容易就想到interval用每隔一定时间发送一个值然后更新snake$，这里通过一个scan操作符记录上次的结果。scan和reduce很像，只是它处理的不是数组而是一个流。现在每秒发送一个值，然后snake更新x坐标加1，y坐标不变，相当于蛇向右边移动。\r\n```jsx\r\n    const snake$ = interval(1000).pipe(\r\n        scan((snake,_) =\u003e {\r\n            //现在我们假设🐍的方向是向右\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            _x = head.x +1;\r\n            _y = head.y;\r\n            return [{x:_x,y:_y}]\r\n        },[{x:1,y:1}])\r\n    )\r\n```\r\n2. 控制蛇的方向\r\n现在蛇可以动了，我们要控制它的方向，通过监听键盘上下左右键，控制蛇的下一个位置.我们加入一个新的流dir\\$,并更新snake\\$。再次强调我们不解释各种操作符的用法，请看注释或者自行学习。\r\n```jsx\r\n    const KEY_EVENTS_DIR = [\r\n        \"ArrowUp\",\r\n        \"ArrowDown\",\r\n        \"ArrowLeft\",\r\n        \"ArrowRight\"\r\n    ]\r\n    const KEY_OPPOSITE = {\r\n        ArrowUp: \"ArrowDown\",\r\n        ArrowDown: \"ArrowUp\",\r\n        ArrowRight: \"ArrowLeft\",\r\n        ArrowLeft: \"ArrowRight\",\r\n    }\r\n    const dir$ = fromEvent(document, \"keydown\").pipe(\r\n        pluck(\"key\"), //从event中取出key\r\n        filter((key) =\u003e KEY_EVENTS_DIR.includes(key)), //过滤掉不是方向键的event\r\n        startWith(\"ArrowRight\"), //设置初始方向\r\n        distinctUntilChanged(),  //同一个键盘连续2次不会重复发送\r\n    );\r\n    const snake$ = interval(1000).pipe(\r\n        withLastFrom(dir$),  //每次interval都去取dir的最新值 \r\n        scan((snake,[_,dir]) =\u003e {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x \u003e= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x \u003c= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y \u003c= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y \u003e= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            return [{x:_x,y:_y}]\r\n        },[{x:1,y:1}])\r\n    )\r\n```\r\n\r\n现在我们可以通过鼠标控制蛇上下左右自由的移动了。但是我希望在手机上也能玩，可以通过监听touch事件实现。所以我们再加一个手势判断的流gestureDir$。读者应该可以看出现在我们代码逻辑很清晰，一个个简单的功能组成最终的功能，各自完成自己的工作。这就是rxjs的强大之处。想一下我们现在不用rxjs，要实现一个dir\\$的功能，感觉有一大堆代码要写，而且很散乱，没有一定的功力很难写的很漂亮逻辑这么清晰。\r\n\r\n```jsx\r\n     const keyDir$ = fromEvent(document, \"keydown\").pipe(\r\n         pluck(\"key\"),\r\n         filter((key) =\u003e KEY_EVENTS_DIR.includes(key)),\r\n         startWith(\"ArrowRight\"),\r\n         distinctUntilChanged(),\r\n     );\r\n\r\n    const gestureDir$ = function () {\r\n        if ('ontouchstart' in document.documentElement) {\r\n            return fromEvent(document, \"touchstart\").pipe(\r\n                switchMap((startEvent) =\u003e\r\n                    fromEvent(document, \"touchmove\").pipe(\r\n                        takeUntil(fromEvent(document, \"touchend\")),\r\n                        takeLast(1),\r\n                        map((event) =\u003e {\r\n                            let deltaX = event.touches[0].pageX - startEvent.touches[0].pageX;\r\n                            let deltaY = event.touches[0].pageY - startEvent.touches[0].pageY;\r\n                            if (deltaX \u003e 0 \u0026\u0026 Math.abs(deltaX) \u003e Math.abs(deltaY)) {\r\n                                return KEY_EVENTS_DIR[3];\r\n                            } else if (deltaX \u003c 0 \u0026\u0026 Math.abs(deltaX) \u003e Math.abs(deltaY)) {\r\n                                return KEY_EVENTS_DIR[2];\r\n                            } else if (deltaY \u003e 0 \u0026\u0026 Math.abs(deltaY) \u003e Math.abs(deltaX)) {\r\n                                return KEY_EVENTS_DIR[1];\r\n                            } else {\r\n                                return KEY_EVENTS_DIR[0]\r\n                            }\r\n                        }),\r\n                    )\r\n                )\r\n            )\r\n        }\r\n        return NEVER\r\n    }()\r\n\r\n    const dir$ = merge(keyDir$, gestureDir$);\r\n    \r\n```\r\n3. 让蛇吃苹果变长\r\n   现在蛇可以控制方向4处移动了，但是还不能变长，我们要实现在蛇吃到苹果时长度增加1并且苹果的位置改变。这里有点复杂，因为snake\\$和food\\$相互关联了起来。snake\\$需要拿到当前food\\$的值来判断是否吃到🍎而food\\$也需要拿到snake的值来生成新的位置但不要和snake的位置重叠。我们引入一个新的流eatFood\\$来通知food\\$。\r\n   ```jsx\r\n\r\n    //随机生成食物\r\n   const createFood = (size, data) =\u003e {\r\n        let x = Math.floor(Math.random() * size);\r\n        let y = Math.floor(Math.random() * size);\r\n        if (data.some(item =\u003e item.x === x \u0026\u0026 item.y === y)) {\r\n            return createFood(size, data);\r\n        }\r\n        return { x, y }\r\n    }\r\n\r\n    const eatFood$ = new BehaviorSubject([]);\r\n\r\n    const food$ = eatFood$.pipe(\r\n        map(snake =\u003e createFood(size, snake)),\r\n        shareReplay(1), //为什么要用shareReplay?\r\n    )\r\n\r\n    const snake$ = interval(1000).pipe(\r\n        withLastFrom(dir$,food$),  //每次interval都去取dir的最新值 \r\n        scan((snake,[_,dir,food]) =\u003e {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x \u003e= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x \u003c= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y \u003c= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y \u003e= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            snake.unshift({ x: _x, y: _y });\r\n                //吃到🍎,通知更新food$\r\n            if (food.x === _x \u0026\u0026 food.y === _y) {\r\n                eatFood$.next(snake) //通知food$更新\r\n            } else {\r\n                snake.pop();\r\n            }\r\n            return [...snake];\r\n        },[{x:1,y:1}])\r\n    )\r\n   ```\r\n4. 增加暂停功能\r\n   现在蛇已经能自由移动，通过吃🍎不断的变长了，游戏的基本逻辑已经实现。接下来我们增加一个暂停和恢复的功能。请注意看pause实现，我们通过switchMap操作符来控制是否往下面的流发送值。\r\n    ```jsx\r\n    const pauseClick$ = fromEvent(document.getElementById(\"pauseORresume\"), \"click\");\r\n\r\n    const pauseKey$ = fromEvent(document, \"keydown\").pipe(\r\n        pluck(\"code\"),\r\n        filter((code) =\u003e code === \"Space\")\r\n    )\r\n\r\n    const pause$ = merge(pauseClick$, pauseKey$).pipe(\r\n        startWith(true),\r\n        scan((current, prev) =\u003e current ? false : true, false)\r\n    )\r\n\r\n    const interval$ = interval(200);\r\n\r\n    const snake$ = pause$.pipe(\r\n        switchMap((isPaused) =\u003e isPaused ? NEVER : inteval$),\r\n        startWith(\"init\"),\r\n        withLastFrom(dir$,food$),  //每次interval都去取dir的最新值 \r\n        scan((snake,[_,dir,food]) =\u003e {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x \u003e= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x \u003c= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y \u003c= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y \u003e= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            snake.unshift({ x: _x, y: _y });\r\n                //吃到🍎,通知更新food$\r\n            if (food.x === _x \u0026\u0026 food.y === _y) {\r\n                eatFood$.next(snake) //通知food$更新\r\n            } else {\r\n                snake.pop();\r\n            }\r\n            return [...snake];\r\n        },[{x:1,y:1}])\r\n    )\r\n   ```\r\n5. 增加gameover判断\r\n现在游戏逻辑基本完成，但是什么时候游戏结束呢，我们还需要实现isGameOver\\$的逻辑，当蛇咬到自己的时候游戏结束，在snake\\$里做判断就行。\r\n```jsx\r\n    const checkGameOver = (snake) =\u003e {\r\n        let head = snake[0];\r\n        return snake.slice(1).some(item =\u003e item.x === head.x \u0026\u0026 item.y ===  head.y);\r\n    }\r\n    const snake$ = pause$.pipe(\r\n        switchMap((isPaused) =\u003e isPaused ? NEVER : inteval$),\r\n        startWith(\"init\"),\r\n        withLastFrom(dir$,food$),  //每次interval都去取dir的最新值 \r\n        scan((snake,[_,dir,food]) =\u003e {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x \u003e= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x \u003c= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y \u003c= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y \u003e= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            snake.unshift({ x: _x, y: _y });\r\n                //吃到🍎,通知更新food$\r\n            if (food.x === _x \u0026\u0026 food.y === _y) {\r\n                eatFood$.next(snake) //通知food$更新\r\n            } else {\r\n                snake.pop();\r\n            }\r\n            if (checkGameOver(snake)) {\r\n                gameOver$.next(true)\r\n            }\r\n            return [...snake];\r\n        },[{x:1,y:1}])\r\n    )\r\n\r\n```\r\n6. 增加reset功能\r\n游戏结束时我们还需要重置游戏的功能。我们先把之前的逻辑整理成一个方法createGame，然后再增加一个startGame的方法，每次reset就重建一个game\\$达到reset的作用。最终代码如下：\r\n```jsx\r\n        const createGame = () =\u003e {\r\n        const gameOver$ = new BehaviorSubject(false);\r\n\r\n        const keyDir$ = fromEvent(document, \"keydown\").pipe(\r\n            pluck(\"key\"),\r\n            filter((key) =\u003e KEY_EVENTS_DIR.includes(key)),\r\n            startWith(\"ArrowRight\"),\r\n            distinctUntilChanged(),\r\n        );\r\n\r\n        const gestureDir$ = function () {\r\n            if ('ontouchstart' in document.documentElement) {\r\n                return fromEvent(document, \"touchstart\").pipe(\r\n                    switchMap((startEvent) =\u003e\r\n                        fromEvent(document, \"touchmove\").pipe(\r\n                            takeUntil(fromEvent(document, \"touchend\")),\r\n                            takeLast(1),\r\n                            map((event) =\u003e {\r\n                                let deltaX = event.touches[0].pageX - startEvent.touches[0].pageX;\r\n                                let deltaY = event.touches[0].pageY - startEvent.touches[0].pageY;\r\n                                if (deltaX \u003e 0 \u0026\u0026 Math.abs(deltaX) \u003e Math.abs(deltaY)) {\r\n                                    return KEY_EVENTS_DIR[3];\r\n                                } else if (deltaX \u003c 0 \u0026\u0026 Math.abs(deltaX) \u003e Math.abs(deltaY)) {\r\n                                    return KEY_EVENTS_DIR[2];\r\n                                } else if (deltaY \u003e 0 \u0026\u0026 Math.abs(deltaY) \u003e Math.abs(deltaX)) {\r\n                                    return KEY_EVENTS_DIR[1];\r\n                                } else {\r\n                                    return KEY_EVENTS_DIR[0]\r\n                                }\r\n                            }),\r\n                        )\r\n                    )\r\n                )\r\n            }\r\n            return NEVER\r\n        }()\r\n\r\n\r\n        const dir$ = merge(keyDir$, gestureDir$);\r\n\r\n        const pauseClick$ = fromEvent(document.getElementById(\"pauseORresume\"), \"click\");\r\n        const pauseKey$ = fromEvent(document, \"keydown\").pipe(\r\n            pluck(\"code\"),\r\n            filter((code) =\u003e code === \"Space\")\r\n        )\r\n        const pause$ = merge(pauseClick$, pauseKey$).pipe(\r\n            startWith(true),\r\n            scan((current, prev) =\u003e current ? false : true, false)\r\n        )\r\n\r\n        const eatFood$ = new BehaviorSubject([]);\r\n\r\n        const score$ = eatFood$.pipe(\r\n            scan((score, _) =\u003e {\r\n                return score + 1\r\n            }, -1)\r\n        )\r\n\r\n        const food$ = eatFood$.pipe(\r\n            map(snake =\u003e createFood(size, snake)),\r\n            shareReplay(1),\r\n        )\r\n\r\n        //增加小需求每吃5个苹果速度增加\r\n        const inteval$ = score$.pipe(\r\n            filter(score =\u003e score % 5 === 0),\r\n            map(score =\u003e {\r\n                let level = Math.floor(score / 5);\r\n                level = level \u003e= 3 ? 3 : level;\r\n                return INTERVAL_TIMES[level];\r\n            }),\r\n            distinctUntilChanged(),\r\n            switchMap((time) =\u003e interval(time)),\r\n        )\r\n\r\n        const snake$ = pause$.pipe(\r\n            switchMap((isPaused) =\u003e isPaused ? NEVER : inteval$),\r\n            startWith(\"init\"),\r\n            withLatestFrom(dir$, food$),\r\n            //快速切换相反方向导致蛇吃到自己\r\n            scan((prev, [_, dir, food]) =\u003e {\r\n                if (KEY_OPPOSITE[dir] === prev[0]) {\r\n                    return [prev[0], food]\r\n                }\r\n                return [dir, food]\r\n            }, []),\r\n            scan((snake, [dir, food]) =\u003e {\r\n                let head = snake[0];\r\n                let _x = head.x;\r\n                let _y = head.y;\r\n                switch (dir) {\r\n                    case \"ArrowRight\":\r\n                        _x = _x \u003e= size - 1 ? 0 : _x + 1;\r\n                        break;\r\n                    case \"ArrowLeft\":\r\n                        _x = _x \u003c= 0 ? size - 1 : _x - 1;\r\n                        break;\r\n                    case \"ArrowUp\":\r\n                        _y = _y \u003c= 0 ? size - 1 : _y - 1;\r\n                        break;\r\n                    case \"ArrowDown\":\r\n                        _y = _y \u003e= size - 1 ? 0 : _y + 1;\r\n                        break;\r\n                }\r\n                snake.unshift({ x: _x, y: _y });\r\n                //吃到🍎,通知更新food$\r\n                if (food.x === _x \u0026\u0026 food.y === _y) {\r\n                    eatFood$.next(snake)\r\n                } else {\r\n                    snake.pop();\r\n                }\r\n                if (checkGameOver(snake)) {\r\n                    gameOver$.next(true)\r\n                }\r\n                return [...snake];\r\n            }, [{ x: 1, y: 1 }]),\r\n        );\r\n\r\n        const game$ = combineLatest([snake$, pause$, food$, score$, gameOver$]).pipe(\r\n            takeWhile(([snake, isPaused, food, score, isGameOver]) =\u003e !isGameOver, true)\r\n        )\r\n        return game$;\r\n    }\r\n\r\n\r\n    const renderGame = ([snake, isPaused, food, score, isGameOver]) =\u003e {\r\n        setState(state =\u003e {\r\n            return {\r\n                ...state,\r\n                snake,\r\n                isPaused,\r\n                food,\r\n                score,\r\n                isGameOver\r\n            }\r\n        })\r\n    }\r\n\r\n    const startGame = () =\u003e {\r\n        const reset$ = fromEvent(document.getElementById(\"reset\"), \"click\");\r\n        const game$ = merge(of(\"startGame\"), reset$).pipe(\r\n            switchMap(x =\u003e createGame()),\r\n        )\r\n        const sub = game$.subscribe(game =\u003e renderGame(game))\r\n        return sub;\r\n    }\r\n\r\n    useEffect(() =\u003e {\r\n        let sub = startGame();\r\n\r\n        return () =\u003e {\r\n            sub.unsubscribe();\r\n        }\r\n    }, [])\r\n```\r\n\r\n# 总结\r\n\r\n通过写一个贪吃蛇游戏确实加深了我对rxjs的理解，之前我也以为我差不多懂rxjs的用法了。但是真正写的时候为了实现各种需求还是遇到了很多问题。以我写这个demo的经验来看，rxjs真的没有说的那么简单，为了实现不同功能在不同的流之间穿插很考验你对rxjs真正理解的程度。但是不得不承认rxjs真的强大，通过组合各种简单方法实现一个复杂的功能，代码思路清晰逻辑分明，容易扩展和维护。那么到底要不要用rxjs呢?我的观点是一定要比较深入理解rxjs了再用，不然你会遇到很多麻烦的。rxjs可能不像react一样简单，随便看看文档懂了jsx和生命周期就可以动手写了。\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/3","createdAt":"2021-06-10T16:15:20Z","tags":[{"name":"react","color":"8E26BB"}],"description":"本文主要介绍使用rxjs和react实现一个经典的贪吃蛇游戏。","keywords":["rxjs","游戏","贪吃蛇"],"headType":"article"},"__N_SSG":true},"page":"/article/[id]","query":{"id":"a545cc6f56f33512f79047fdad298b65"},"buildId":"next-build","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>