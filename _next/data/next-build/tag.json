{"pageProps":{"list":[{"id":"e098078f0874d05907b3bbdac951bda1","title":"react-native-webviewåŠ è½½ç¬¬ä¸‰æ–¹iframe","body":"### 1. ç¬¬ä¸‰æ–¹iframe é‡åˆ°cross-originé—®é¢˜\r\n[è®¾ç½®baseUrlä¸iframeçš„domainç›¸åŒ](https://github.com/react-native-webview/react-native-webview/blob/master/docs/Reference.md#)\r\n```(javascript)\r\nconst ChatModal = ({ uuid, token, language, isLogin, dispatch, chatModal }) => {\r\n    const { shown } = chatModal;\r\n    // const [isLoading, setIsLoading] = useState(false);\r\n\r\n    const closeModal = () => {\r\n        dispatch({\r\n            type: 'modal/closeChatModal',\r\n        });\r\n    };\r\n\r\n    const handleMessage = ({ nativeEvent }) => {\r\n        const data = nativeEvent.data;\r\n        if (data === 'close') {\r\n            closeModal();\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Modal animationType=\"fade\" transparent={false} visible={shown}>\r\n            <SafeAreaView style={styles.container}>\r\n                <WebView\r\n                    source={{ html: html, baseUrl: 'https://chat.sleekflow.io/' }}\r\n                    style={styles.webview}\r\n                    onMessage={handleMessage}\r\n                />\r\n            </SafeAreaView>\r\n        </Modal>\r\n    );\r\n};\r\n```\r\n### 2.  é€šè¿‡postMessage å‘rnå‘é€event\r\n```(javascript)\r\nrootWindow.ReactNativeWebView.postMessage('close'); \r\n```\r\n\r\n### 3. [react-nativeä¸­è°ƒè¯•js](https://github.com/react-native-webview/react-native-webview/blob/master/docs/Debugging.md#:~:text=Open%20Safari%20Preferences%20%2D%3E%20%22Advanced,you%20would%20on%20the%20web)\r\n### 3.1 iosä¸­è°ƒè¯•js\r\n\r\n1. Open Safari Preferences -> \"Advanced\" tab -> enable checkbox \"Show Develop menu in menu bar\"\r\n2. Start app with React Native WebView in iOS simulator or iOS device\r\n3. Safari -> Develop -> [device name] -> [app name] -> [url - title]\r\n4. You can now debug the WebView contents just as you would on the web\r\n\r\n### 3.2 androidä¸­è°ƒè¯•js\r\n\r\n1. You will need to make the following change to MainApplication.java to enabled web contents debugging: \r\n```java\r\nimport android.webkit.WebView;\r\n\r\n  @Override\r\n  public void onCreate() {\r\n    super.onCreate();\r\n\t  ...\r\n    WebView.setWebContentsDebuggingEnabled(true);\r\n  }\r\n```\r\n2. Start app with React Native WebView in Android emulator or Android device\r\n3. Open chrome://inspect/#devices on Chrome\r\n4. Select your device on the left and select \"Inspect\" on the WebView contents you'd like to inspect\r\n5. You can now debug the WebView contents just as you would on the web\r\n\r\n### 4. html source code\r\n```(html)\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n    <head>\r\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0\">\r\n        <style>\r\n            html,body{\r\n                margin:0;\r\n                padding:0\r\n            }\r\n            #loading-overlay{\r\n                position:absolute;\r\n                width:100%;\r\n                height:100vh;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                z-index:2147483647;\r\n                background-color:white;\r\n            }\r\n            .lds-spinner {\r\n            color: official;\r\n            display: inline-block;\r\n            position: relative;\r\n            width: 80px;\r\n            height: 80px;\r\n            transform:scale(0.8)\r\n            }\r\n            .lds-spinner div {\r\n            transform-origin: 40px 40px;\r\n            animation: lds-spinner 1.2s linear infinite;\r\n            }\r\n            .lds-spinner div:after {\r\n            content: \" \";\r\n            display: block;\r\n            position: absolute;\r\n            top: 3px;\r\n            left: 37px;\r\n            width: 6px;\r\n            height: 18px;\r\n            border-radius: 20%;\r\n            background: blue;\r\n            }\r\n            .lds-spinner div:nth-child(1) {\r\n            transform: rotate(0deg);\r\n            animation-delay: -1.1s;\r\n            }\r\n            .lds-spinner div:nth-child(2) {\r\n            transform: rotate(30deg);\r\n            animation-delay: -1s;\r\n            }\r\n            .lds-spinner div:nth-child(3) {\r\n            transform: rotate(60deg);\r\n            animation-delay: -0.9s;\r\n            }\r\n            .lds-spinner div:nth-child(4) {\r\n            transform: rotate(90deg);\r\n            animation-delay: -0.8s;\r\n            }\r\n            .lds-spinner div:nth-child(5) {\r\n            transform: rotate(120deg);\r\n            animation-delay: -0.7s;\r\n            }\r\n            .lds-spinner div:nth-child(6) {\r\n            transform: rotate(150deg);\r\n            animation-delay: -0.6s;\r\n            }\r\n            .lds-spinner div:nth-child(7) {\r\n            transform: rotate(180deg);\r\n            animation-delay: -0.5s;\r\n            }\r\n            .lds-spinner div:nth-child(8) {\r\n            transform: rotate(210deg);\r\n            animation-delay: -0.4s;\r\n            }\r\n            .lds-spinner div:nth-child(9) {\r\n            transform: rotate(240deg);\r\n            animation-delay: -0.3s;\r\n            }\r\n            .lds-spinner div:nth-child(10) {\r\n            transform: rotate(270deg);\r\n            animation-delay: -0.2s;\r\n            }\r\n            .lds-spinner div:nth-child(11) {\r\n            transform: rotate(300deg);\r\n            animation-delay: -0.1s;\r\n            }\r\n            .lds-spinner div:nth-child(12) {\r\n            transform: rotate(330deg);\r\n            animation-delay: 0s;\r\n            }\r\n            @keyframes lds-spinner {\r\n            0% {\r\n                opacity: 1;\r\n            }\r\n            100% {\r\n                opacity: 0;\r\n            }\r\n            }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div id=\"loading-overlay\">\r\n            <div class=\"lds-spinner\"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>\r\n        </div>\r\n    </body>\r\n    <script \r\n        src=\"https://chat.sleekflow.io/embed_iframe.js\" \r\n        data-id=\"travischatwidget\"\r\n        data-companyid=\"e1922105-8004-4724-97c7-859b7ff5dedf\"\r\n        type=\"text/javascript\"\r\n    >\r\n    </script>\r\n    <script>\r\n        const rootWindow = window;\r\n        const loadingEle = document.querySelector('#loading-overlay') //loading\r\n\r\n        function start(){\r\n            function checkLoad(iframe){\r\n                const iframeWindow = iframe.contentWindow.window;\r\n                const rootIframeEle = iframeWindow.document.getElementById(\"travischatroot\");\r\n                const floatButton = rootIframeEle.querySelector(\"div>button\")\r\n                if(floatButton){\r\n                    floatButton.click();\r\n                    setTimeout(() => {\r\n                        loadingEle.remove();\r\n                        const closeButton = rootIframeEle.querySelector(\"#scrollConatiner>div>button\")\r\n                        if(closeButton){\r\n                            closeButton.onclick = function(e){\r\n                                e.stopPropagation()\r\n                                rootWindow.ReactNativeWebView.postMessage('close'); \r\n                            }\r\n                        }\r\n                    }, 500);\r\n                }else{\r\n                    setTimeout(function(){\r\n                        checkLoad(iframe);\r\n                    },500)\r\n                }\r\n            }\r\n\r\n            const iframeEle = document.querySelector('iframe#travischatwidget')\r\n            if(iframeEle){\r\n                iframeEle.addEventListener('load',function(){\r\n                    checkLoad(iframeEle)\r\n                })\r\n            }else{\r\n                setTimeout(function(){\r\n                    start()\r\n                },500)\r\n            }\r\n        }\r\n        \r\n        window.onload = function(){\r\n            start();\r\n        }\r\n    </script> \r\n</html>\r\n```\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/14","createdAt":"2022-04-11T14:40:39Z","tags":[{"name":"javascript","color":"1d76db"},{"name":"react-native","color":"5319e7"}]},{"id":"844206ed01e814fc9438e7b4e9add988","title":"react-native-cameraæ‹ç…§å›¾ç‰‡è‡ªåŠ¨æ—‹è½¬","body":"[Android: captured image is always rotated](https://github.com/react-native-camera/react-native-camera/issues/1807)\r\n[taking photos in landscape mode is rotating the photo 90Âº (turning to portrait)](https://github.com/react-native-camera/react-native-camera/issues/1570)","url":"https://github.com/gwl002/gwl002.github.io/issues/13","createdAt":"2022-03-28T03:43:27Z","tags":[]},{"id":"c8f8e9c93e4779383ed990a92b6c0831","title":"ç†è§£animation-fill-modeå±æ€§","body":"animation-fill-modeä½œä¸ºcss3åŠ¨ç”»çš„ä¸€ä¸ªé‡è¦å±æ€§å¾ˆå¸¸è§ï¼Œä½†æ˜¯å¤§å¤šç”¨äºæŠŠåŠ¨ç”»åœåœ¨æœ€åä¸€å¸§ï¼Œä¹Ÿå°±æ˜¯**forwards**å€¼çš„ç”¨æ³•ã€‚åœ¨å¤šå¹´çš„å‰ç«¯å¼€å‘ä¸­å¾ˆå°‘å…³æ³¨å…¶ä»–å‡ ä¸ªå€¼ï¼Œä»Šå¤©çœ‹[æ–‡æ¡£](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-fill-mode)å‘ç°å¯¹äºbackwards(ä¸€ç›´ä»¥ä¸ºå°±æ˜¯å›åˆ°åˆå§‹çŠ¶æ€å’Œnoneæ²¡ä»€ä¹ˆä¸¤æ ·)å’Œbothä¸€ç›´æ²¡æœ‰æ­£ç¡®çš„äº†è§£ï¼Œæ–‡æ¡£è‹±æ–‡æè¿°æ™¦æ¶©éš¾æ‡‚ï¼Œdemoä¹Ÿæ²¡æœ‰ä»€ä¹ˆè¯¦ç»†è¯´æ˜ï¼Œæ‰€ä»¥æ‰“ç®—ä¸€æ¢ç©¶ç«Ÿã€‚\r\n\r\n### å±æ€§å€¼\r\n- none é»˜è®¤å€¼\r\n> The animation will not apply any styles to the target when it's not executing. The element will instead be displayed using any other CSS rules applied to it. This is the default value.\r\n\r\n    åœ¨åŠ¨ç”»ä¸æ‰§è¡Œæ—¶ï¼Œä¸ä¼šèµ‹äºˆä»»ä½•targetä»»ä½•styleï¼ŒåŠ¨ç”»æ‰§è¡Œç»“æŸå›å½’åŸæ ·\r\n- forwards\r\n> The target will retain the computed values set by the last keyframe encountered during execution.\r\n\r\n    targetåœ¨åŠ¨ç”»æ‰§è¡Œç»“æŸåä¿æŒæœ€åä¸€å¸§çš„style\r\n- backwards\r\n\r\n> The animation will apply the values defined in the first relevant keyframe as soon as it is applied to the target, and retain this during the animation-delay period.\r\n\r\n    åŠ¨ç”»å°†åœ¨æ‰§è¡Œçš„ç¬¬ä¸€æ—¶é—´å°†styleèµ‹äºˆtargetï¼ŒåŒ…æ‹¬delayçš„æ—¶å€™ï¼Œè¿™å°±æ˜¯noneå’Œbackwardsçš„åŒºåˆ«ï¼Œå½“ç¬¬ä¸€å¸§çš„å±æ€§å’ŒtargetåŸæ¥çš„å±æ€§ä¸åŒçš„æ—¶å€™ç‰¹åˆ«æ˜æ˜¾ã€‚\r\n- both\r\n\r\n> The animation will follow the rules for both forwards and backwards, thus extending the animation properties in both directions.\r\n    åŠ¨ç”»å°†åŒæ—¶æœ‰forwardså’Œafterwardsçš„ç‰¹æ€§ã€‚\r\n\r\n### [demo](https://jsfiddle.net/gwl002/57drgsct/23/)\r\næ¯”è¾ƒ4ä¸ªå€¼ä¸åŒçš„è¡¨ç°\r\n- none å°çƒå…ˆæ˜¯ç»¿è‰²ï¼Œdelay3ç§’åæ‰å˜ä¸ºçº¢è‰²ï¼Œæœ€åå˜é»„è‰²ï¼Œå›åˆ°åŸç‚¹\r\n- forwards å°çƒå…ˆæ˜¯ç»¿è‰²ï¼Œdelay3ç§’åæ‰å˜ä¸ºçº¢è‰²ï¼Œæœ€åå˜é»„è‰²ï¼Œä¿æŒåœ¨ç»ˆç‚¹\r\n- afterwards å°çƒç›´æ¥å˜çº¢è‰²ï¼Œdelay3ç§’åï¼ŒåŠ¨ç”»å¼€å§‹ï¼Œæ…¢æ…¢å˜é»„è‰²ï¼ŒåŠ¨ç”»ç»“æŸå›åˆ°åŸç‚¹\r\n- both å°çƒç›´æ¥å˜çº¢è‰²ï¼Œdelay3ç§’åï¼ŒåŠ¨ç”»å¼€å§‹ï¼Œæ…¢æ…¢å˜é»„è‰²ï¼ŒåŠ¨ç”»ç»“æŸä¿æŒåœ¨ç»ˆç‚¹\r\n\r\n### æ€»ç»“\r\nä»¥å‰æƒ³å½“ç„¶çš„ä»¥ä¸ºafterwardså°±æ˜¯å›åˆ°åŸç‚¹ï¼Œforwardså°±æ˜¯ä¿æŒåœ¨ç»ˆç‚¹ï¼Œå…¶å®æ˜¯é”™è¯¯çš„ã€‚afterwardsæ˜¯åœ¨åŠ¨ç”»å¼€å§‹æ—¶ç¬¬ä¸€æ—¶é—´é€‰æ‹©ç¬¬ä¸€å¸§çš„styleï¼Œæœ‰delayå°±æ˜¯delayå¼€å§‹æ—¶ã€‚\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/12","createdAt":"2021-12-21T14:49:31Z","tags":[{"name":"css","color":"F49416"}],"description":"ç†è§£cssåŠ¨ç”»å±æ€§animation-fill-modeä¸ºbothçš„æƒ…å†µ","keywords":["css","animation","animation-fill-mode"]},{"id":"0bbbbb167d67a80165c6ffc3a65d61c4","title":"\"Android build error  AAPT: error: resource android:attr/lStar not found\"","body":"### é—®é¢˜\r\nExecution failed for task ':app:processDebugResources'.\r\n> A failure occurred while executing com.android.build.gradle.internal.tasks.Workers$ActionFacade\r\n   > Android resource linking failed\r\n     /Users/devingong/.gradle/caches/transforms-2/files-2.1/f616efa5326a198920e8ac1c64cb6655/core-1.8.0-alpha02/res/values/values.xml:105:5-114:25: AAPT: error: resource android:attr/lStar not found.\r\n\r\n### è§£å†³åŠæ³•\r\næ·»åŠ androidXCore = \"1.6.0\"\r\n```groovy\r\nbuildscript {\r\n    ext {\r\n        buildToolsVersion = \"28.0.3\"\r\n        minSdkVersion = 21\r\n        compileSdkVersion = 29\r\n        targetSdkVersion = 28\r\n        adroidXCore = \"1.6.0\"\r\n    }\r\n    repositories {\r\n        google()\r\n        jcenter()\r\n    }\r\n    dependencies {\r\n        classpath(\"com.android.tools.build:gradle:3.5.3\")\r\n        // NOTE: Do not place your application dependencies here; they belong\r\n        // in the individual module build.gradle files\r\n    }\r\n}\r\n```\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/11","createdAt":"2021-12-20T03:01:03Z","tags":[{"name":"å·¥ä½œç»éªŒ","color":"bfdadc"},{"name":"react-native","color":"5319e7"}]},{"id":"a4ed040911fb1de4110cbb53cb12df7b","title":"No signature found in package of version 2","body":"### æœ€è¿‘googleplayè¦æ±‚å°†android target versionå‡çº§è‡³30ï¼Œä¸ç„¶ä¸èƒ½ä¸Šstoreã€‚å‡çº§ååˆå‘ç°åœ¨android11ä¸Šinstallå¤±è´¥ã€‚æŸ¥æ‰¾åŸå› å‘ç°ï¼Œåœ¨å®‰å“11çš„æœºå™¨ä¸Šadb installåå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Œsearchåå‘ç°åŸæ¥android11ä»¥åä¸å†æ”¯æŒv1ç­¾åï¼Œå¿…é¡»ä½¿ç”¨v2ç­¾åã€‚\r\n![image](https://user-images.githubusercontent.com/18588945/142794410-c6ff32ab-157d-4db6-ad2b-283ebfab6f2b.png)\r\n\r\n### v1ç­¾åå’Œv2ç­¾åçš„åŒºåˆ«\r\n```\r\nV1ï¼šå¯å¯¹ç­¾ååçš„æ–‡ä»¶ï¼Œä½œé€‚å½“ä¿®æ”¹ï¼Œå¹¶é‡æ–°å‹ç¼©ã€‚ \r\nV2ï¼šä¸èƒ½å¯¹ç­¾ååçš„ APKä½œä»»ä½•ä¿®æ”¹ï¼ŒåŒ…æ‹¬é‡æ–°è§£å‹ã€‚å› ä¸ºå®ƒæ˜¯é’ˆå¯¹å­—èŠ‚è¿›è¡Œçš„ç­¾åï¼Œæ‰€ä»¥ä»»ä½•æ”¹åŠ¨éƒ½ä¼šå½±å“æœ€ç»ˆç»“æœã€‚\r\n```\r\n\r\n### è§£å†³æ–¹æ¡ˆ\r\n1. æ‰‹åŠ¨\r\n```\r\nsigningConfigs {\r\n        debug {\r\n            storeFile file('xxxxx.jks')\r\n            storePassword '123456'\r\n            keyAlias 'dev'\r\n            keyPassword '123456'\r\n            v2SigningEnabled true\r\n        }\r\n    }\r\n```\r\n2. appcenter\r\nåˆ æ‰keystoreæ–‡ä»¶ï¼Œé‡æ–°ä¸Šä¼ å°±è‡ªåŠ¨å¥½äº†\r\n[https://github.com/microsoft/appcenter/issues/1990#issuecomment-856960698](url)\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/10","createdAt":"2021-11-22T03:10:39Z","tags":[{"name":"å·¥ä½œç»éªŒ","color":"bfdadc"},{"name":"react-native","color":"5319e7"}]},{"id":"7bbc5d66b3b4be1d1738caac348a4ee7","title":"react-native 0.62åœ¨xcode13é‡åˆ°build errorè§£å†³","body":"æœ€è¿‘ä¸ºäº†å°†appé¡¹ç›®å‘å¸ƒåˆ°ios15ç‰ˆæœ¬ï¼Œå‡çº§äº†xcodeåˆ°13ï¼Œé‡åˆ°å‡ ä¸ªbugï¼Œè¿™é‡Œè®°å½•è§£å†³æ–¹æ¡ˆã€‚\r\n\r\n### 1. No matching function for call to 'RCTBridgeModuleNameForClass'\r\n```\r\n# åœ¨ ios/Podfile ä¸­åŠ å…¥ä¸€ä¸‹ä»£ç \r\ndef find_and_replace(dir, findstr, replacestr)\r\n    Dir[dir].each do |name|\r\n        text = File.read(name)\r\n        replace = text.gsub(findstr,replacestr)\r\n        if text != replace\r\n            puts \"Fix: \" + name\r\n            File.open(name, \"w\") { |file| file.puts replace }\r\n            STDOUT.flush\r\n        end\r\n    end\r\n    Dir[dir + '*/'].each(&method(:find_and_replace))\r\n  end\r\npost_install do |installer|\r\n  ## ä»¥ä¸‹ Fix for XCode 12.5\r\n    find_and_replace(\r\n    \"../node_modules/react-native/React/CxxBridge/RCTCxxBridge.mm\",\r\n    \"_initializeModules:(NSArray<id<RCTBridgeModule>> *)modules\", \r\n    \"_initializeModules:(NSArray<Class> *)modules\")\r\n    \r\n    find_and_replace(\r\n    \"../node_modules/react-native/ReactCommon/turbomodule/core/platform/ios/RCTTurboModuleManager.mm\",\r\n    \"RCTBridgeModuleNameForClass(strongModule))\", \r\n    \"RCTBridgeModuleNameForClass(Class(strongModule)))\"\r\n    )\r\n    installer.pods_project.targets.each do |target|\r\n      target.build_configurations.each do |config|\r\n        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '9.0'\r\n      end\r\n    end\r\n  end\r\n```\r\n### 2. undefined symbol: __swift_force_load_$_swiftfileprovider\r\n[rnå®˜æ–¹æœ€æ–°è§£å†³æ–¹æ¡ˆ](https://github.com/facebook/react-native/commit/eb938863063f5535735af2be4e706f70647e5b90)\r\n\r\n### 3. åˆ é™¤flipperç›¸å…³ä»£ç \r\n\r\n[ç›¸å…³é“¾æ¥](https://github.com/facebook/react-native/issues/31480)","url":"https://github.com/gwl002/gwl002.github.io/issues/9","createdAt":"2021-09-08T06:04:12Z","tags":[]},{"id":"0a541890680756b16f51cf1680e2c53d","title":"webpackåˆ†åŒ…å­¦ä¹ ç¬”è®°","body":"### 1. optimization.runtimeChunk\r\nè®¾ç½®runtimeChunkæ˜¯å°†åŒ…å«chunks æ˜ å°„å…³ç³»çš„ listå•ç‹¬ä» app.jsé‡Œæå–å‡ºæ¥ï¼Œå› ä¸ºæ¯ä¸€ä¸ª chunk çš„ id åŸºæœ¬éƒ½æ˜¯åŸºäºå†…å®¹ hash å‡ºæ¥çš„ï¼Œæ‰€ä»¥æ¯æ¬¡æ”¹åŠ¨éƒ½ä¼šå½±å“å®ƒï¼Œå¦‚æœä¸å°†å®ƒæå–å‡ºæ¥çš„è¯ï¼Œç­‰äºapp.jsæ¯æ¬¡éƒ½ä¼šæ”¹å˜ã€‚ç¼“å­˜å°±å¤±æ•ˆäº†ã€‚è®¾ç½®runtimeChunkä¹‹åï¼Œwebpackå°±ä¼šç”Ÿæˆä¸€ä¸ªä¸ªruntime~xxx.jsçš„æ–‡ä»¶ã€‚\r\n```jsx\r\nmodule.exports = {\r\n  //...\r\n  optimization: {\r\n    runtimeChunk: {\r\n      name: (entrypoint) => `runtime~${entrypoint.name}`,\r\n    },\r\n    // boolean\r\n    // string single | multiple\r\n    // object name:()=>null\r\n};\r\n```\r\n### 2. optimization.moduleIds å’Œ optimization.chunkIds\r\n[webpackç¨³å®šmoduleidå’Œchunkidä»¥å®ç°æŒä¹…åŒ–ç¼“å­˜çš„æ¢³ç†](https://blog.csdn.net/weixin_33727510/article/details/91362710)\r\n\r\n### 3. optimization.splitChunks\r\n[ç†è§£webpack4.splitChunks](https://www.cnblogs.com/kwzm/p/10314438.html)","url":"https://github.com/gwl002/gwl002.github.io/issues/8","createdAt":"2021-06-25T14:55:49Z","tags":[]},{"id":"46711a24cc4d8cb347b59e2d9be84884","title":"scriptæ ‡ç­¾ä¸Šasync å’Œ deferçš„åŒºåˆ«","body":"ç»å¸¸çœ‹åˆ°ä¸€äº›cdnçš„scriptæ ‡ç­¾ä¸Šæœ‰asyncå’Œdeferï¼ŒçŸ¥é“å¤§æ¦‚æ˜¯å¼‚æ­¥åŠ è½½å´ä¸€ç›´æ²¡æ·±ç©¶åˆ°åº•æœ‰ä»€ä¹ˆç”¨ï¼Œä»Šå¤©çœ‹åˆ°ä¸€ç‰‡åšæ–‡ï¼Œå¤§æ¦‚äº†è§£äº†è¿™ä¸¤è€…çš„ä½œç”¨å’ŒåŒºåˆ«ã€‚\r\n\r\n# JS åŠ è½½é˜»å¡\r\n\r\n```\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\"/>\r\n    <script src=\"https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js\"></script>\r\n</head>\r\n<body>\r\n    <h1>æˆ‘æ˜¯ h1 æ ‡ç­¾</h1>\r\n</body>\r\n</html>\r\n```\r\nå°†æµè§ˆå™¨ç½‘é€Ÿè°ƒåˆ°50k/sä¼šå‘ç°ï¼Œåˆ·æ–°æµè§ˆå™¨ï¼Œè§‚å¯Ÿ Elements é¢ï¼Œä¸€ç›´æœªåŠ è½½å‡º h1 æ ‡ç­¾ï¼ˆæœŸé—´é¡µé¢ä¸€ç›´ç™½å±ï¼‰ï¼Œç›´åˆ° JS åŠ è½½å®Œæˆåï¼ŒDOM ä¸­æ‰å‡ºç°ï¼Œè¿™è¶³ä»¥è¯´æ˜äº† JS ä¼šé˜»å¡å®šä¹‰åœ¨å…¶ä¹‹åçš„ DOM çš„åŠ è½½ã€‚\r\n\r\n```\r\n<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\"/>\r\n    <script async src=\"https://cdn.bootcss.com/jquery/2.1.4/jquery.min.js\"></script>\r\n</head>\r\n<body>\r\n    <h1>æˆ‘æ˜¯ h1 æ ‡ç­¾</h1>\r\n</body>\r\n</html>\r\n```\r\nåœ¨scriptä¸ŠåŠ ä¸Šasync(å¼‚æ­¥)æˆ–è€…defer(å»¶è¿Ÿ)ä¼šå‘ç°éƒ½ä¸ä¼šé˜»å¡DOMçš„åŠ è½½ã€‚é‚£ä¹ˆäºŒè€…æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿåˆ†ææµè§ˆé‡åˆ°scriptçš„æµç¨‹ï¼š\r\n1. æš‚åœè§£æ DOMï¼›\r\n2. æ‰§è¡Œ script é‡Œçš„è„šæœ¬ï¼Œå¦‚æœè¯¥ script æ˜¯å¤–é“¾ï¼Œåˆ™ä¼šå…ˆä¸‹è½½å®ƒï¼Œä¸‹è½½å®Œæˆåç«‹åˆ»æ‰§è¡Œï¼›\r\n3. æ‰§è¡Œå®Œæˆåç»§ç»­è§£æå‰©ä½™ DOMã€‚\r\n\r\nä½†æ˜¯deferå’Œasyncæœ‰æ‰€ä¸åŒã€‚\r\n\r\n# deferçš„ç‰¹ç‚¹\r\n- å¯¹äº defer çš„ scriptï¼Œæµè§ˆå™¨ä¼šç»§ç»­è§£æ htmlï¼Œä¸”åŒæ—¶å¹¶è¡Œä¸‹è½½è„šæœ¬ï¼Œç­‰ DOM æ„å»ºå®Œæˆåï¼Œæ‰ä¼šå¼€å§‹æ‰§è¡Œè„šæœ¬ï¼Œæ‰€ä»¥å®ƒä¸ä¼šé€ æˆé˜»å¡ï¼›\r\n- defer è„šæœ¬ä¸‹è½½å®Œæˆåï¼Œæ‰§è¡Œæ—¶é—´ä¸€å®šæ˜¯ DOMContentLoaded äº‹ä»¶è§¦å‘ä¹‹å‰æ‰§è¡Œï¼›\r\n- **å¤šä¸ª defer çš„è„šæœ¬æ‰§è¡Œé¡ºåºä¸¥æ ¼æŒ‰ç…§å®šä¹‰é¡ºåºè¿›è¡Œï¼Œè€Œä¸æ˜¯å…ˆä¸‹è½½å¥½çš„å…ˆæ‰§è¡Œï¼›**\r\n\r\n# async ç‰¹ç‚¹\r\n- å¯¹äº async çš„ scriptï¼Œæµè§ˆå™¨ä¼šç»§ç»­è§£æ htmlï¼Œä¸”åŒæ—¶å¹¶è¡Œä¸‹è½½è„šæœ¬ï¼Œä¸€æ—¦è„šæœ¬ä¸‹è½½å®Œæˆä¼šç«‹åˆ»æ‰§è¡Œï¼›å’Œ defer ä¸€æ ·ï¼Œå®ƒåœ¨ä¸‹è½½çš„æ—¶å€™ä¹Ÿä¸ä¼šé€ æˆé˜»å¡ï¼Œä½†æ˜¯å¦‚æœå®ƒä¸‹è½½å®Œæˆå DOM è¿˜æ²¡è§£æå®Œæˆï¼Œåˆ™æ‰§è¡Œè„šæœ¬çš„æ—¶å€™æ˜¯ä¼šé˜»å¡è§£æçš„ï¼›\r\n- async è„šæœ¬çš„æ‰§è¡Œ å’Œ DOMContentLoaded çš„è§¦å‘é¡ºåºæ— æ³•æ˜ç¡®è°å…ˆè°åï¼Œå› ä¸ºè„šæœ¬å¯èƒ½åœ¨ DOM æ„å»ºå®Œæˆæ—¶è¿˜æ²¡ä¸‹è½½å®Œï¼Œä¹Ÿå¯èƒ½æ—©å°±ä¸‹è½½å¥½äº†ï¼›\r\n- å¤šä¸ª asyncï¼ŒæŒ‰ç…§è°å…ˆä¸‹è½½å®Œæˆè°å…ˆæ‰§è¡Œçš„åŸåˆ™è¿›è¡Œï¼Œæ‰€ä»¥å½“å®ƒä»¬ä¹‹é—´æœ‰é¡ºåºä¾èµ–çš„æ—¶å€™ç‰¹åˆ«å®¹æ˜“å‡ºé”™ã€‚\r\n\r\n> defer å’Œ async éƒ½åªèƒ½ç”¨äºå¤–éƒ¨è„šæœ¬ï¼Œå¦‚æœ script æ²¡æœ‰ src å±æ€§ï¼Œåˆ™ä¼šå¿½ç•¥å®ƒä»¬ã€‚\r\n\r\n# æ€»ç»“\r\næ ¹æ®deferå’Œasyncçš„ä¸åŒç‰¹ç‚¹å¯ä»¥å¾—å‡ºä¸€äº›ç»“è®ºï¼Œåœ¨ä¸€äº›éœ€è¦ç›¸äº’ä¾èµ–çš„è„šæœ¬ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œçš„è„šæœ¬éœ€è¦ä½¿ç”¨deferï¼›è€Œæ²¡æœ‰ä¾èµ–å…³ç³»è°å…ˆä¸‹è½½å®Œè°å…ˆæ‰§è¡Œå°±å¥½çš„æƒ…å†µä¸‹å¯ä»¥ç”¨asyncã€‚\r\n\r\n# å‚è€ƒæ–‡çŒ®\r\n1. [æ¢ç©¶ç½‘é¡µèµ„æºç©¶ç«Ÿæ˜¯å¦‚ä½•é˜»å¡æµè§ˆå™¨åŠ è½½çš„](https://bubuzou.com/2020/12/26/browser-block/)\r\n2. [æµ…è°ˆscriptæ ‡ç­¾ä¸­çš„asyncå’Œdefer](https://www.cnblogs.com/jiasm/p/7683930.html)\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/7","createdAt":"2021-06-25T14:48:06Z","tags":[{"name":"javascript","color":"1d76db"}]},{"id":"4c3e4ca0899dd22eeb674d05e4811887","title":"react-nativeä¸‹è½½pdfæ–‡ä»¶","body":"å¾ˆä¹…å°±å®ç°è¿‡çš„åŠŸèƒ½ï¼Œä»Šå¤©åˆé‡åˆ°äº†ï¼Œç«Ÿç„¶æ— ä»ä¸‹æ‰‹ï¼Œåªå¥½å»ç¿»ç¿»æ—§ä»£ç å¹¶åœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ä¹Ÿæ–¹ä¾¿æ—¥åæŸ¥çœ‹ã€‚\r\n\r\n# éœ€æ±‚åˆ†æ\r\n- ajaxè¯·æ±‚pdfæ–‡ä»¶\r\n- è½¬æˆbase64\r\n- ä¸‹è½½åˆ°æ‰‹æœºï¼Œéœ€è¦èƒ½ä»å¤–éƒ¨Appæ‰“å¼€\r\n\r\n### 1. é¦–å…ˆè·å–pdfæ–‡ä»¶äºŒè¿›åˆ¶\r\n```jsx\r\nasync function getPdfBinary(url) {\r\n    return new Promise((resolve, reject) => {\r\n        var xhr = new XMLHttpRequest();\r\n        xhr.open(\"GET\", url, true);\r\n        xhr.responseType = \"arraybuffer\"; // get the binary \r\n        xhr.setRequestHeader('content-type', 'application/json');\r\n        xhr.onload = function (event) {\r\n            var arrayBuffer = xhr.response;\r\n            var byteArray = new Uint8Array(arrayBuffer);\r\n            var len = byteArray.byteLength;\r\n            var binary = \"\"\r\n            for (var i = 0; i < len; i++) {\r\n                binary += String.fromCharCode(byteArray[i]);\r\n            }\r\n            resolve(binary);\r\n        }\r\n        xhr.send();\r\n    })\r\n}\r\n\r\n```\r\n### 2. è½¬æˆbase64å­—ç¬¦ä¸²\r\n```jsx\r\n//react-native å¹¶æ²¡æœ‰btoaå’Œatobæ–¹æ³• éœ€è¦è‡ªå·±å®ç°\r\nfunction base64_encode(str) {\r\n    var c1, c2, c3;\r\n    var base64EncodeChars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\";\r\n    var i = 0,\r\n        len = str.length,\r\n        string = '';\r\n\r\n    while (i < len) {\r\n        c1 = str.charCodeAt(i++) & 0xff;\r\n        if (i == len) {\r\n            string += base64EncodeChars.charAt(c1 >> 2);\r\n            string += base64EncodeChars.charAt((c1 & 0x3) << 4);\r\n            string += \"==\";\r\n            break;\r\n        }\r\n        c2 = str.charCodeAt(i++);\r\n        if (i == len) {\r\n            string += base64EncodeChars.charAt(c1 >> 2);\r\n            string += base64EncodeChars.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));\r\n            string += base64EncodeChars.charAt((c2 & 0xF) << 2);\r\n            string += \"=\";\r\n            break;\r\n        }\r\n        c3 = str.charCodeAt(i++);\r\n        string += base64EncodeChars.charAt(c1 >> 2);\r\n        string += base64EncodeChars.charAt(((c1 & 0x3) << 4) | ((c2 & 0xF0) >> 4));\r\n        string += base64EncodeChars.charAt(((c2 & 0xF) << 2) | ((c3 & 0xC0) >> 6));\r\n        string += base64EncodeChars.charAt(c3 & 0x3F)\r\n    }\r\n    return string\r\n}\r\n```\r\n### 3. ä¸‹è½½åˆ°androidæ‰‹æœº\r\nä»Šå¤©åˆšå¥½åœ¨stackoverflowä¸Šå›ç­”åˆ«äººçš„é—®é¢˜ï¼Œä»–éœ€è¦çš„æ˜¯expoï¼Œæ‰€ä»¥å†™äº†ä¸ªexpoç‰ˆæœ¬çš„ã€‚[Base64 String to pdf JavaScript React Native then download](https://stackoverflow.com/questions/68076316/base64-string-to-pdf-javascript-react-native-then-download/68076982#68076982)\r\nFor expo\r\n```jsx\r\nconst downloadForAos = async (pdfBase64Str) => {\r\n    const folder = FileSystem.StorageAccessFramework.getUriForDirectoryInRoot(\"test\");\r\n    const permissions = await FileSystem.StorageAccessFramework.requestDirectoryPermissionsAsync(folder);\r\n    if (!permissions.granted) return;\r\n\r\n    let filePath = await FileSystem.StorageAccessFramework.createFileAsync(permissions.directoryUri, \"test.pdf\", \"application/pdf\");\r\n    // let filePath = \"content://com.android.externalstorage.documents/tree/primary%3Atest/document/primary%3Atest%2Ftest.txt\";\r\n    console.log(pdfBase64Str, \"====\");\r\n    try {\r\n        await FileSystem.StorageAccessFramework.writeAsStringAsync(filePath, pdfBase64Str, { encoding: FileSystem.EncodingType.Base64 });\r\n        alert(\"download success!\")\r\n    } catch (err) {\r\n        console.log(err);\r\n    }\r\n}\r\n```\r\nFor android\r\n``` jsx\r\nconst downloadForAos = async (pdfBase64Str) => {\r\n    const fileName = `/${Date.now()}_report.pdf`;\r\n    const path = RNFS.DownloadDirectoryPath + fileName;\r\n    try {\r\n        const granted = await PermissionsAndroid.request(\r\n            PermissionsAndroid.PERMISSIONS.WRITE_EXTERNAL_STORAGE,\r\n        );\r\n        if (granted) {\r\n            RNFS.writeFile(path, pdfBase64Str, \"base64\").then(res => {\r\n                ToastAndroid.show(I18n.t(\"myHealth.Downloaded\"), ToastAndroid.SHORT);\r\n            }).catch(error => {\r\n                ToastAndroid.show(I18n.t(\"myHealth.DownloadFailed\"), ToastAndroid.SHORT);\r\n            })\r\n        }\r\n    } catch (err) {\r\n        console.warn(err);\r\n    }\r\n}\r\n```\r\n### 4. ä¸‹è½½åˆ°iosæ‰‹æœº\r\niosä¸èƒ½ç›´æ¥ä¸‹è½½æ–‡ä»¶åˆ°å¤–éƒ¨appï¼Œåªèƒ½é€šè¿‡åˆ†äº«åˆ°file appå®ç°ã€‚æ‰¾äº†å¾ˆä¹…æ²¡æ‰¾åˆ°å…¶ä»–åŠæ³•ï¼Œæœ‰å…¶ä»–åŠæ³•çš„å¤§ç¥è¯·å¤šå¤šæŒ‡æ•™ã€‚\r\n```jsx\r\nconst downloadPdfForIos = async (pdf) => {\r\n    const url = \"data:application/pdf;base64,\" + pdf;\r\n    const shareOptions = {\r\n        title: 'image report',\r\n        failOnCancel: false,\r\n        saveToFiles: true,\r\n        url: url, // base64 with mimeType or path to local file\r\n    };\r\n    try {\r\n        const ShareResponse = await Share.open(shareOptions);\r\n        Alert.alert(\r\n            null,\r\n            I18n.t(\"myHealth.Downloaded\"),\r\n            [\r\n                {\r\n                    text: I18n.t(\"common.OK\"),\r\n                    onPress: () => null\r\n                }\r\n            ]\r\n        );\r\n    } catch (error) {\r\n        if (error.error && error.error.code === \"ECANCELLED500\") {\r\n            console.warn(\"canceled\");\r\n        } else {\r\n            Alert.alert(\r\n                null,\r\n                I18n.t(\"myHealth.DownloadFailed\"),\r\n                [\r\n                    {\r\n                        text: I18n.t(\"common.OK\"),\r\n                        onPress: () => null\r\n                    }\r\n                ]\r\n            );\r\n        }\r\n    }\r\n}\r\n\r\n```\r\n\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/6","createdAt":"2021-06-22T12:55:44Z","tags":[{"name":"react-native","color":"5319e7"}]},{"id":"ad487137feaed0cb496babdfc158080d","title":"ä½¿ç”¨imagemagicåˆ¶ä½œç“¦ç‰‡åœ°å›¾","body":"ä¹‹å‰æœ‰ä¸ªé¡¹ç›®å®¢æˆ·ç»™ä¸€å¼ ç²¾åº¦å¾ˆé«˜çš„å›¾è®©åšæˆé‚£ç§èƒ½å¤Ÿç¼©æ”¾çš„åœ°å›¾çš„æ•ˆæœã€‚ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯ç›´æ¥åŠ è½½å¤§å›¾ï¼Œç„¶åé€šè¿‡æ‰‹åŠ¿å»æ§åˆ¶å›¾ç‰‡çš„scaleæ¥å®ç°ï¼Œåæ¥è§‰å¾—ä¸å¦¥ï¼Œé«˜ç²¾åº¦å›¾ç‰‡çš„ä½“ç§¯å®åœ¨å¤ªå¤§ï¼ŒåŠ è½½æ—¶é—´å¤ªé•¿ï¼Œæ•ˆæœå¾ˆä¸å¥½ã€‚é€šè¿‡ç ”ç©¶å‘ç°[openlayers](https://openlayers.org/)è¿™ç§ä¸“é—¨ç”¨æ¥åŠ è½½åœ°å›¾çš„åº“æ‰æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯æ€ä¹ˆæŠŠå›¾ç‰‡åˆ¶ä½œæˆé‚£ç§ç“¦ç‰‡åœ°å›¾æ˜¯ä¸ªé—®é¢˜ã€‚\r\n\r\n>ç“¦ç‰‡åœ°å›¾é‡‘å­—å¡”æ¨¡å‹æ˜¯ä¸€ç§å¤šåˆ†è¾¨ç‡å±‚æ¬¡æ¨¡å‹ï¼Œä»ç“¦ç‰‡é‡‘å­—å¡”çš„åº•å±‚åˆ°é¡¶å±‚ï¼Œåˆ†è¾¨ç‡è¶Šæ¥è¶Šä½ï¼Œä½†è¡¨ç¤ºçš„åœ°ç†èŒƒå›´ä¸å˜ã€‚é¦–å…ˆç¡®å®šåœ°å›¾æœåŠ¡å¹³å°æ‰€è¦æä¾›çš„ç¼©æ”¾çº§åˆ«çš„æ•°é‡Nï¼ŒæŠŠç¼©æ”¾çº§åˆ«æœ€é«˜ã€åœ°å›¾æ¯”ä¾‹å°ºæœ€å¤§çš„åœ°å›¾å›¾ç‰‡ä½œä¸ºé‡‘å­—å¡”çš„åº•å±‚ï¼Œå³ç¬¬0å±‚ï¼Œå¹¶å¯¹å…¶è¿›è¡Œåˆ†å—ï¼Œä»åœ°å›¾å›¾ç‰‡çš„å·¦ä¸Šè§’å¼€å§‹ï¼Œä»å·¦è‡³å³ã€ä»ä¸Šåˆ°ä¸‹è¿›è¡Œåˆ‡å‰²ï¼Œåˆ†å‰²æˆç›¸åŒå¤§å°(æ¯”å¦‚256x256åƒç´ )çš„æ­£æ–¹å½¢åœ°å›¾ç“¦ç‰‡ï¼Œå½¢æˆç¬¬0å±‚ç“¦ç‰‡çŸ©é˜µ;åœ¨ç¬¬0å±‚åœ°å›¾å›¾ç‰‡çš„åŸºç¡€ä¸Šï¼ŒæŒ‰æ¯åƒç´ åˆ†å‰²ä¸º2Ã—2ä¸ªåƒç´ çš„æ–¹æ³•ç”Ÿæˆç¬¬1å±‚åœ°å›¾å›¾ç‰‡ï¼Œå¹¶å¯¹å…¶è¿›è¡Œåˆ†å—ï¼Œåˆ†å‰²æˆä¸ä¸‹ä¸€å±‚ç›¸åŒå¤§å°çš„æ­£æ–¹å½¢åœ°å›¾ç“¦ç‰‡ï¼Œå½¢æˆç¬¬1å±‚ç“¦ç‰‡çŸ©é˜µ;é‡‡ç”¨åŒæ ·çš„æ–¹æ³•ç”Ÿæˆç¬¬2å±‚ç“¦ç‰‡çŸ©é˜µ;â€¦;å¦‚æ­¤ä¸‹å»ï¼Œç›´åˆ°ç¬¬Nä¸€1å±‚ï¼Œæ„æˆæ•´ä¸ªç“¦ç‰‡é‡‘å­—å¡”ã€‚\r\n\r\n# åŸç†\r\nç“¦ç‰‡åœ°å›¾çš„åŸç†å¾ˆç®€å•ã€‚å‡è®¾å®¢æˆ·ç»™çš„åŸå›¾ä¸ºï¼ˆ512*4ï¼Œ512*4ï¼‰ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ°å›¾èƒ½å¤Ÿè¾¾åˆ°çš„æœ€é«˜åˆ†è¾¨ç‡ï¼Œä½†æ˜¯å‡è®¾æˆ‘ä»¬çš„è§†çª—åªæœ‰512*512ï¼Œæ­¤æ—¶æˆ‘ä»¬åªèƒ½çœ‹åˆ°å·¦ä¸Šè§’1/16çš„éƒ¨åˆ†ã€‚å‡è®¾ç”¨æˆ·æœ€å¼€å§‹çœ‹åˆ°çš„å›¾åŒ…å«æ•´ä¸ªåœ°å›¾ï¼Œä¹Ÿå°±æ˜¯512*512ï¼Œæ­¤æ—¶åœ°å›¾è¢«ç¼©æ”¾äº†16å€ï¼Œå®½é«˜ä¸ª4å€ï¼Œæ­¤æ—¶è®¾levelä¸º1ï¼Œé‚£ä¹ˆå½“æ”¾å¤§ä¸€å€æ—¶ï¼Œæ­¤æ—¶åœ°å›¾å®é™…å›¾ç‰‡å¤§å°ä¸ºï¼ˆ512*2ï¼Œ512*2ï¼‰ï¼Œæ­¤æ—¶levelä¸º2ï¼Œå½“å†æ”¾å¤§ä¸€å€æ—¶ï¼Œæ­¤æ—¶levelä¸º3ï¼Œåˆšå¥½ä¸ºåŸå›¾ï¼Œåˆ†è¾¨ç‡æœ€é«˜ã€‚é‚£ä¹ˆæˆ‘ä»¬åªè¦æƒ³åŠæ³•æŠŠåŸå›¾æŒ‰ä¸åŒlevelç¼©æ”¾åˆ‡å‰²å°±è¡Œã€‚level1å°±æ˜¯ç›´æ¥å®½é«˜å„ç¼©æ”¾4å€ï¼Œlevel2å„ç¼©æ”¾2å€ï¼Œå†æŠŠå®ƒåˆ‡æˆ4å¼ ï¼Œæ¯å¼ å¤§å°ä¸º512*512ï¼Œlevel3çš„æ—¶å€™ä¸ç”¨ç¼©æ”¾ï¼Œç›´æ¥åˆ‡æˆ16å¼ ï¼ŒåŒæ ·æ¯å¼ 512*512.æˆ‘ä»¬æŠŠ\r\nä¸åŒlevelçš„å›¾ç‰‡æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åç”¨èƒ½å¤ŸåŠ è½½ç“¦ç‰‡åœ°å›¾çš„åº“å°±èƒ½åŠ è½½ï¼Œä¾‹å¦‚openlayersã€‚æ‰€ä»¥æˆ‘ä»¬å‰©ä¸‹çš„é—®é¢˜å°±æ˜¯æ€ä¹ˆåˆ‡å›¾äº†ã€‚\r\n```javascript\r\nimport 'ol/ol.css';\r\nimport Map from 'ol/Map';\r\nimport TileLayer from 'ol/layer/Tile';\r\nimport View from 'ol/View';\r\nimport XYZ from 'ol/source/XYZ';\r\n\r\nvar map = new Map({\r\n  target: 'map',\r\n  layers: [\r\n    new TileLayer({\r\n      source: new XYZ({\r\n        url:\r\n          'https://localhost:9080/tiles/{z}-{x}-{y}.png'    //å› ä¸ºæˆ‘çš„å›¾ç‰‡æ˜¯ 1-1-1è¿™ç§å½¢å¼ç»„æˆæ‰€ä»¥è¿™é‡Œæ˜¯è¿™æ ·ï¼Œå¦‚æœä½ çš„å›¾ç‰‡æ˜¯æŒ‰ç­‰çº§æ”¾åœ¨ä¸åŒæ–‡ä»¶å¤¹è¦å†™æˆ https://localhost:9080/tiles/{z}/{x}/{y}.png å…·ä½“æ€ä¹ˆæ”¾è¦çœ‹ä½ å¦‚ä½•ç»„ç»‡çš„tilesç»“æ„\r\n      }),\r\n    }) ],\r\n  view: new View({\r\n    center: [-472202, 7530279],\r\n    zoom: 12,\r\n  }),\r\n});\r\n```\r\n\r\n<img width=\"967\" alt=\"QQ20210615-225842@2x\" src=\"https://user-images.githubusercontent.com/18588945/122076316-5af83c00-ce2d-11eb-9f5e-b144e416ee1f.png\">\r\n\r\n# ä½¿ç”¨imagemagicå¤„ç†å›¾ç‰‡\r\n> Use ImageMagickÂ® to create, edit, compose, or convert digital images. It can read and write images in a variety of formats (over 200) including PNG, JPEG, GIF, WebP, HEIC, SVG, PDF, DPX, EXR and TIFF. ImageMagick can resize, flip, mirror, rotate, distort, shear and transform images, adjust image colors, apply various special effects, or draw text, lines, polygons, ellipses and BÃ©zier curves.\r\n\r\n[imagemagic](https://imagemagick.org/index.php)æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å›¾ç‰‡å¤„ç†å·¥å…·ï¼Œå¯ä»¥ç”¨å‘½ä»¤è¡Œç›´æ¥å¤„ç†å›¾ç‰‡ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°å„ç§å›¾ç‰‡å¤„ç†æ“ä½œã€‚è™½ç„¶å¾ˆå¼ºå¤§ä½†ä¸å¾—ä¸è¯´æ–‡æ¡£å¾ˆæ™¦æ¶©éš¾æ‡‚ï¼Œæˆ‘ä¹Ÿåªæ˜¯ä¸ºäº†å®Œæˆè¿™ä¸ªä»»åŠ¡ç†Ÿæ‚‰äº†å‡ ä¸ªå‘½ä»¤è€Œå·²ï¼Œå®Œå…¨è°ˆä¸ä¸Šç²¾é€šã€‚\r\n[æˆ‘ä»¬çš„åˆ‡å›¾å·¥å…·åˆ†2ä¸ªæ­¥éª¤ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯æŒ‰ä¸åŒlevelåˆ‡å›¾ï¼Œä½†æ˜¯å› ä¸ºå¹¶ä¸æ˜¯åˆšå¥½å¦‚åŸç†åˆ†æé‡Œè®²çš„é‚£ä¹ˆåˆšå¥½å°±æ˜¯æ•´æ•°å€ï¼Œåœ°å›¾åŸå›¾å¾€å¾€ä¸æ˜¯åˆšå¥½æ˜¯æ­£æ–¹å½¢ï¼Œæ¯”å¦‚åˆ‡çš„ç“¦ç‰‡æ¯ä¸ªä¸º512*512ï¼Œåˆ‡åˆ°è¾¹ä¸Šçš„æ—¶å€™å¯èƒ½åªæœ‰360*400è¿™æ ·çš„ï¼Œè¿™æ—¶éœ€è¦æŠŠå®ƒè¡¥æˆ512*512ï¼Œä¸ç„¶ä¼šæœ‰å¥‡æ€ªçš„ç°è±¡å‘ç”Ÿã€‚æ³¨æ„ï¼Œè„šæœ¬é‡Œæœ‰äº›å‚æ•°è¦æ ¹æ®ä½ çš„å®é™…æƒ…å†µè‡ªå·±è®¾ç½®ã€‚[æºç åœ°å€](https://github.com/gwl002/imagemagicScript)\r\n```bash\r\n#! /bin/bash\r\n#cropFile.sh\r\nINDEX=1\r\nIMAGE_WIDTH=10752   #åŸå›¾å®½åº¦\r\nIMAGE_HEIGHT=21504  #åŸå›¾é«˜åº¦\r\n\r\nfor file in `ls \"originImages\"`;do #å°†åŸå›¾æ”¾åœ¨orginalImagesæ–‡ä»¶å¤¹ä¸‹\r\n\techo \"processing ${file}\"\r\n\tfile_base=$(basename $file .png) #æ‹¿åˆ°åŸå›¾åç§°\r\n\ttiles_dir=\"${file_base}_tiles\"   #ç¢°åˆ°æœ‰æ— ç›®æ ‡æ–‡ä»¶å¤¹ï¼Œæœ‰åˆ™ç›´æ¥ä¸‹ä¸€æ­¥ï¼Œæ²¡æœ‰å°±å»ºç«‹æ–‡ä»¶å¤¹\r\n\tif [ -e \"${tiles_dir}\" ] && [ -d \"${tiles_dir}\" ];then \r\n\t\techo \"${tiles_dir} exisit\"\r\n\telse\r\n\t\techo \"mkdir ${tiles_dir}\"\r\n\t\tmkdir \"${tiles_dir}\"\r\n\t\techo \"mkdir ${tiles_dir} completed\"\r\n\tfi\r\n\tfor (( i=1; i<=7; i++));do    #æ ¹æ®ä½ è‡ªå·±çš„éœ€æ±‚è°ƒèŠ‚æ‰€éœ€çš„ç­‰çº§\r\n\t\techo \"processing ${file} scale ${i}\"\r\n\t\t((level= 7 - i))\r\n\t\t((scale= 2 ** (i-1)))\r\n\t\t((width= $IMAGE_WIDTH / $scale))\r\n\t\t((height= $IMAGE_HEIGHT / $scale))\r\n\t\tresizeFormat=\"${width}x${height}\"\r\n\t\techo $resizeFormat\r\n\t\tconvert \"originImages/${file}\" -resize $resizeFormat -crop 512x512 -set filename:tile ./${tiles_dir}/${level}-%[fx:page.x/512]-%[fx:page.y/512] %[filename:tile].png\r\n\t\techo \"complete ${file} scale ${i}\"\r\n\tdone\r\n\techo \"complete ${file}\"\r\n\tlet INDEX=${INDEX}+1\r\ndone\r\n```\r\n```bash\r\n#! /bin/bash\r\n#fillSize.sh\r\nSTART=`date +%s%N`;\r\nfor folder in `ls | grep \"H*tiles\"`;do  #æ‰¾åˆ°æ‰€æœ‰ä¹‹å‰åˆ‡ç‰‡ç”Ÿæˆçš„æ–‡ä»¶å¤¹ï¼Œéå†å…¶ä¸­æ‰¾åˆ°å…¶ä¸­å°ºå¯¸ä¸å¯¹çš„ï¼Œå°†å…¶æ”¾ç½®åœ¨512*512é€æ˜å›¾çš„å·¦ä¸Šè§’\r\n\techo $folder\r\n\tfor image in `ls $folder`;do\r\n\t\techo $image\r\n\t\tratio=`identify \"${folder}/${image}\" | cut -d \" \" -f 3`\r\n\t\tif [ \"$ratio\" != \"128x128\" ];then\r\n\t\t\techo $ratio\r\n\t\t\tconvert \"${folder}/${image}\" -background transparent -gravity NorthWest -extent 512x512 \"${folder}/${image}\"\r\n\t\tfi \r\n\tdone\r\ndone\r\nEND=`date +%s%N`;\r\ntime=$((END-START))\r\ntime=`expr $time / 1000000`\r\necho \"totally spend time ${time}\"\r\n```\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/5","createdAt":"2021-06-15T15:45:09Z","tags":[{"name":"å·¥ä½œç»éªŒ","color":"bfdadc"}]},{"id":"376b7ba8c34b49441c91df07b6bbbb56","title":"next-blog","body":"æµ‹è¯•å†™ä¸€ä¸ªnext-blog","url":"https://github.com/gwl002/gwl002.github.io/issues/4","createdAt":"2021-06-11T02:42:50Z","tags":[{"name":"react","color":"8E26BB"}],"description":"some desc","keywords":[1,2,3]},{"id":"a545cc6f56f33512f79047fdad298b65","title":"rxjså®ç°è´ªåƒè›‡å°æ¸¸æˆ","body":"åˆè¯†rxjsæ„Ÿè§‰æƒŠå¥‡ï¼Œæ„Ÿè§‰å¾ˆå¤šå¤æ‚çš„é€»è¾‘å¥½åƒç”¨rxjsæ¥å†™å˜å¾—ç®€å•æ˜äº†ã€‚æ–­æ–­ç»­ç»­å¾—å­¦ä¹ äº†ä¸€é˜µå­ï¼Œæ„Ÿè§‰å¾ˆå¥½ï¼Œå´ä¸€ç›´æ²¡æœ‰çœŸæ­£åœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¿‡ã€‚å­¦ä¹ è€Œä¸ä½¿ç”¨è¿‡ä¸äº†å¤šä¹…å°±ä¼šå¿˜è®°ï¼Œæ‰€ä»¥è¿™æ¬¡å†™ä¸€ä¸ªå°demoæ¥åŠ æ·±ä¸€ä¸‹å°è±¡ã€‚é‚£ä¹ˆå†™ä»€ä¹ˆå¥½å‘¢ï¼Œæƒ³åˆ°ä»¥å‰ç”¨reactå†™è¿‡è´ªåƒè›‡å°æ¸¸æˆï¼Œæ®è¯´rxjså¾ˆé€‚åˆç”¨æ¥å¼€å‘æ¸¸æˆç±»ç¨‹åºï¼Œæ‰€ä»¥å†³å®šç”¨rxjsæ¥å†™ä¸€ä¸ªç»å…¸çš„è´ªåƒè›‡å°æ¸¸æˆã€‚\r\n\r\næœ¬æ–‡å¹¶ä¸ä»‹ç»rxjsåŸç†å’Œå„ç§æ“ä½œç¬¦çš„ä½¿ç”¨ï¼Œä¸»è¦è§£é‡Šä¸€ä¸‹å®ç°çš„é€»è¾‘ã€‚\r\n[æºç ](https://github.com/gwl002/rxjsSnakeGame)\r\n[demoå±•ç¤º](https://gwl002.github.io/game/greedySnake)\r\næ¨èå‡ ä¸ªæˆ‘ç»å¸¸å­¦ä¹ çš„ç½‘ç«™ï¼š\r\n\r\n- [30 å¤©ç²¾é€š RxJS (00)ï¼š é—œæ–¼æœ¬ç³»åˆ—æ–‡ç« ](https://ithelp.ithome.com.tw/articles/10186103) å°æ¹¾åŒèƒæ—©å¹´å†™çš„æ•™ç¨‹ï¼Œå†™çš„å¾ˆå¥½ï¼Œä»åŸç†åˆ°ä½¿ç”¨éƒ½è®²çš„å¾ˆå¥½ï¼Œè¿˜æœ‰ä¸€äº›ç”ŸåŠ¨çš„ä¾‹å­ï¼Œè™½ç„¶ç‰ˆæœ¬å’Œå†™æ³•å·²ç»æœ‰äº›ä¸åŒï¼Œä½†å¹¶ä¸å½±å“å­¦ä¹ ã€‚\r\n- [å®˜ç½‘](https://rxjs.dev/)\r\n- [Learn Rxjs](https://www.learnrxjs.io/)å¾ˆå¥½çš„å­¦ä¹ ç½‘ç«™ï¼Œæ¯ä¸ªæ“ä½œç¬¦çš„è§£é‡Šå’Œä¾‹å­ï¼Œä»¥åŠå„ç§demoã€‚\r\n\r\n# å®ç°UI\r\né¦–å…ˆçœ‹ä¸€ä¸‹æ•´ä½“çš„ç•Œé¢ï¼ŒåŒ…æ‹¬Board(è›‡ç§»åŠ¨çš„èŒƒå›´)ã€Snake(çº¢è‰²ï¼‰ã€Food(ç»¿è‰²)ã€Score(åˆ†æ•°)ã€æš‚åœå’Œé‡ç½®æŒ‰é’®ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨reactæ¥æ¸²æŸ“è§†å›¾ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨canvasï¼Œæˆ‘ä»¬åªæ³¨é‡äºé€»è¾‘ï¼Œä¸å…³å¿ƒuiã€‚æˆ‘ä»¬é‡‡å–æ•°æ®é©±åŠ¨è§†å›¾çš„æ€ç»´å¼€å‘ï¼Œé€»è¾‘å’Œé¡µé¢å…ƒç´ æ˜¯è§£è€¦åˆï¼Œè¿™ç§æ€ç»´å¯ä»¥è®©æˆ‘ä»¬å¾ˆè½»æ¾ä»reactæ¸²æŸ“åˆ‡æ¢åˆ°canvasæ¸²æŸ“ã€‚\r\n\r\n![image](https://user-images.githubusercontent.com/18588945/122550390-291dea00-d066-11eb-8077-2a827aeccc11.png)\r\n\r\n### Board \r\nè¿™ä¸ªç»“æ„æ˜¯åŸºæœ¬ä¸å˜çš„ï¼Œåªæ¸²æŸ“ä¸€æ¬¡å°±å¤Ÿäº†ï¼Œå½“ç„¶æŠŠgameoverç§»é™¤æ›´å¥½ï¼Œæ‡‚reactçš„åº”è¯¥ç†è§£ä¸ºä»€ä¹ˆç”¨memoã€‚\r\n```jsx\r\n\r\nconst GameOver = ({ isGameOver }) => {\r\n    if (!isGameOver) return null;\r\n    return (\r\n        <h1 className=\"center\">GAME OVER</h1>\r\n    )\r\n}\r\n\r\nconst Board = memo(({ winWidth, size, isGameOver }) => {\r\n    const itemWidth = winWidth / size;\r\n\r\n    const Row = ({ rowIndex }) => {\r\n        return (\r\n            <div className=\"rowContainer\">\r\n                {\r\n                    Array(size).fill().map((item, index) => (\r\n                        <span key={index} className=\"boardItem\" style={{ width: itemWidth, height: itemWidth }}>\r\n                            <span></span>\r\n                        </span>\r\n                    ))\r\n                }\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div id=\"board\">\r\n            {\r\n                Array(size).fill().map((item, index) => <Row key={index} />)\r\n            }\r\n            <GameOver isGameOver={isGameOver} />\r\n        </div>\r\n    )\r\n})\r\n```\r\n### Snake å’Œ Food\r\n```jsx\r\nconst Food = ({ food, itemWidth }) => {\r\n    if (!food) return null;\r\n\r\n    return (\r\n        <span\r\n            className=\"boardItem\"\r\n            style={{\r\n                position: \"absolute\",\r\n                width: itemWidth,\r\n                height: itemWidth,\r\n                left: itemWidth * food.x,\r\n                top: itemWidth * food.y,\r\n                backgroundColor: \"green\"\r\n            }}\r\n        >\r\n            <span></span>\r\n        </span>\r\n    )\r\n\r\n}\r\n\r\nconst Snake = memo(({ data, itemWidth }) => {\r\n    return (\r\n        <>\r\n            {data.map((item, index) =>\r\n                <span\r\n                    // key={`${item.x}-${item.y}`}\r\n                    key={index}\r\n                    className=\"boardItem\"\r\n                    style={{\r\n                        position: \"absolute\",\r\n                        width: itemWidth,\r\n                        height: itemWidth,\r\n                        left: itemWidth * item.x,\r\n                        top: itemWidth * item.y,\r\n                        backgroundColor: \"red\"\r\n                    }}\r\n                >\r\n                    <span></span>\r\n                </span>\r\n            )}\r\n        </>\r\n    )\r\n})\r\n```\r\n### App\r\næŠŠå„ä¸ªç»„ä»¶æ•´åˆèµ·æ¥\r\n```jsx\r\nconst App = () => {\r\n    const size = 20;\r\n    const [ref, { width }] = useMeasure();\r\n\r\n    const itemWidth = width / size;\r\n\r\n    const initialState = {\r\n        isGameOver: false,\r\n        score: 0,\r\n        snake: [\r\n\r\n        ],\r\n        food: null,\r\n        isPaused: true\r\n    }\r\n\r\n    const [state, setState] = useState(initialState);\r\n\r\n    const renderGame = ([snake, isPaused, food, score, isGameOver]) => {\r\n        setState(state => {\r\n            return {\r\n                ...state,\r\n                snake,\r\n                isPaused,\r\n                food,\r\n                score,\r\n                isGameOver\r\n            }\r\n        })\r\n    }\r\n\r\n    return (\r\n        <>\r\n            <Head>\r\n                <link rel=\"stylesheet\" href=\"/styles/greedySnake.css\" />\r\n            </Head>\r\n            {width > 0 ? null : <Loading />}\r\n            <div className=\"snakeGame\" ref={ref} style={{ visibility: width > 0 ? \"visible\" : \"hidden\" }}>\r\n                <Board winWidth={width} size={size} isGameOver={state.isGameOver} />\r\n                <Snake itemWidth={itemWidth} data={state.snake} />\r\n                <Food itemWidth={itemWidth} food={state.food} />\r\n                <div>\r\n                    <button id=\"pauseORresume\">{\r\n                        state.isPaused ? \"START\" : \"PAUSE\"\r\n                    }</button>\r\n                </div>\r\n                <div>\r\n                    <button id=\"reset\">reset</button>\r\n                </div>\r\n                <span>{state.score}</span>\r\n            </div>\r\n        </>\r\n    )\r\n}\r\n```\r\nç°åœ¨æˆ‘ä»¬å·²ç»å®ç°äº†åŸºæœ¬çš„é¡µé¢ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„å†™æ¸¸æˆçš„é€»è¾‘é©±åŠ¨å„å…ƒç´ åŠ¨èµ·æ¥ã€‚\r\n\r\n# å®ç°æ¸¸æˆçš„é€»è¾‘\r\n\r\n### é€»è¾‘æ€»ä½“åˆ†æ\r\né¦–å…ˆæˆ‘ä»¬åˆ†ærenderGameæ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬éœ€è¦snakeã€foodã€isPausedã€isGameoverã€score5ä¸ªå€¼æ¥æè¿°æ¸¸æˆçš„å½“å‰çŠ¶æ€ã€‚é‚£ä¹ˆæˆ‘ä»¬è®¾ç«‹5ä¸ªæµsnake\\$ã€food\\$ã€isPaused\\$ã€isGameover\\$ã€score\\$æ¥æè¿°è¿™5ä¸ªçŠ¶æ€ï¼Œè¿™5ä¸ªæµä»»ä½•ä¸€ä¸ªæ›´æ–°æˆ‘ä»¬å°±é‡åˆ·æ¸¸æˆçš„çŠ¶æ€ã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬çš„ä»£ç çœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™æ ·çš„ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨combineLastæ¥è·å–æ¯ä¸ªæµçš„æœ€æ–°å€¼ï¼Œä¸æ‡‚combineLastçš„å¯ä»¥å…ˆå»å®˜ç½‘çœ‹çœ‹æ•™ç¨‹ã€‚rxjsçš„æ“ä½œç¬¦ç¡®å®åšå¤§ç²¾æ·±ï¼Œä¸€ä¸ªæ“ä½œç¬¦å°±èƒ½å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼Œç»„åˆèµ·æ¥æ›´åŠ ç²¾å¦™ã€‚\r\n```jsx\r\nconst snake$ = of([{x:1,y:1}])\r\nconst food$ = of([{x:4,y:4}])\r\nconst isPaused$ = of(true)\r\nconst isGameOver$ = of(falsse)\r\nconst score$ = of(0)\r\n\r\nconst game$ = combineLatest([snake$, pause$, food$, score$, gameOver$]).pipe(\r\n            takeWhile(([snake, isPaused, food, score, isGameOver]) => !isGameOver, true)\r\n        )\r\n\r\nuseEffect(()=>{\r\n    const sub = game$.subscribe(game => renderGame(game))\r\n    return () => {\r\n        sub.unsubcribe();\r\n    }\r\n})\r\n```\r\n### å®ç°snake$\r\n\r\n1. è®©è›‡åŠ¨èµ·æ¥\r\né¦–å…ˆæˆ‘ä»¬è®©è›‡åŠ¨èµ·æ¥ï¼Œå¾ˆå®¹æ˜“å°±æƒ³åˆ°intervalç”¨æ¯éš”ä¸€å®šæ—¶é—´å‘é€ä¸€ä¸ªå€¼ç„¶åæ›´æ–°snake$ï¼Œè¿™é‡Œé€šè¿‡ä¸€ä¸ªscanæ“ä½œç¬¦è®°å½•ä¸Šæ¬¡çš„ç»“æœã€‚scanå’Œreduceå¾ˆåƒï¼Œåªæ˜¯å®ƒå¤„ç†çš„ä¸æ˜¯æ•°ç»„è€Œæ˜¯ä¸€ä¸ªæµã€‚ç°åœ¨æ¯ç§’å‘é€ä¸€ä¸ªå€¼ï¼Œç„¶åsnakeæ›´æ–°xåæ ‡åŠ 1ï¼Œyåæ ‡ä¸å˜ï¼Œç›¸å½“äºè›‡å‘å³è¾¹ç§»åŠ¨ã€‚\r\n```jsx\r\n    const snake$ = interval(1000).pipe(\r\n        scan((snake,_) => {\r\n            //ç°åœ¨æˆ‘ä»¬å‡è®¾ğŸçš„æ–¹å‘æ˜¯å‘å³\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            _x = head.x +1;\r\n            _y = head.y;\r\n            return [{x:_x,y:_y}]\r\n        },[{x:1,y:1}])\r\n    )\r\n```\r\n2. æ§åˆ¶è›‡çš„æ–¹å‘\r\nç°åœ¨è›‡å¯ä»¥åŠ¨äº†ï¼Œæˆ‘ä»¬è¦æ§åˆ¶å®ƒçš„æ–¹å‘ï¼Œé€šè¿‡ç›‘å¬é”®ç›˜ä¸Šä¸‹å·¦å³é”®ï¼Œæ§åˆ¶è›‡çš„ä¸‹ä¸€ä¸ªä½ç½®.æˆ‘ä»¬åŠ å…¥ä¸€ä¸ªæ–°çš„æµdir\\$,å¹¶æ›´æ–°snake\\$ã€‚å†æ¬¡å¼ºè°ƒæˆ‘ä»¬ä¸è§£é‡Šå„ç§æ“ä½œç¬¦çš„ç”¨æ³•ï¼Œè¯·çœ‹æ³¨é‡Šæˆ–è€…è‡ªè¡Œå­¦ä¹ ã€‚\r\n```jsx\r\n    const KEY_EVENTS_DIR = [\r\n        \"ArrowUp\",\r\n        \"ArrowDown\",\r\n        \"ArrowLeft\",\r\n        \"ArrowRight\"\r\n    ]\r\n    const KEY_OPPOSITE = {\r\n        ArrowUp: \"ArrowDown\",\r\n        ArrowDown: \"ArrowUp\",\r\n        ArrowRight: \"ArrowLeft\",\r\n        ArrowLeft: \"ArrowRight\",\r\n    }\r\n    const dir$ = fromEvent(document, \"keydown\").pipe(\r\n        pluck(\"key\"), //ä»eventä¸­å–å‡ºkey\r\n        filter((key) => KEY_EVENTS_DIR.includes(key)), //è¿‡æ»¤æ‰ä¸æ˜¯æ–¹å‘é”®çš„event\r\n        startWith(\"ArrowRight\"), //è®¾ç½®åˆå§‹æ–¹å‘\r\n        distinctUntilChanged(),  //åŒä¸€ä¸ªé”®ç›˜è¿ç»­2æ¬¡ä¸ä¼šé‡å¤å‘é€\r\n    );\r\n    const snake$ = interval(1000).pipe(\r\n        withLastFrom(dir$),  //æ¯æ¬¡intervaléƒ½å»å–dirçš„æœ€æ–°å€¼ \r\n        scan((snake,[_,dir]) => {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x >= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x <= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y <= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y >= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            return [{x:_x,y:_y}]\r\n        },[{x:1,y:1}])\r\n    )\r\n```\r\n\r\nç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡é¼ æ ‡æ§åˆ¶è›‡ä¸Šä¸‹å·¦å³è‡ªç”±çš„ç§»åŠ¨äº†ã€‚ä½†æ˜¯æˆ‘å¸Œæœ›åœ¨æ‰‹æœºä¸Šä¹Ÿèƒ½ç©ï¼Œå¯ä»¥é€šè¿‡ç›‘å¬touchäº‹ä»¶å®ç°ã€‚æ‰€ä»¥æˆ‘ä»¬å†åŠ ä¸€ä¸ªæ‰‹åŠ¿åˆ¤æ–­çš„æµgestureDir$ã€‚è¯»è€…åº”è¯¥å¯ä»¥çœ‹å‡ºç°åœ¨æˆ‘ä»¬ä»£ç é€»è¾‘å¾ˆæ¸…æ™°ï¼Œä¸€ä¸ªä¸ªç®€å•çš„åŠŸèƒ½ç»„æˆæœ€ç»ˆçš„åŠŸèƒ½ï¼Œå„è‡ªå®Œæˆè‡ªå·±çš„å·¥ä½œã€‚è¿™å°±æ˜¯rxjsçš„å¼ºå¤§ä¹‹å¤„ã€‚æƒ³ä¸€ä¸‹æˆ‘ä»¬ç°åœ¨ä¸ç”¨rxjsï¼Œè¦å®ç°ä¸€ä¸ªdir\\$çš„åŠŸèƒ½ï¼Œæ„Ÿè§‰æœ‰ä¸€å¤§å †ä»£ç è¦å†™ï¼Œè€Œä¸”å¾ˆæ•£ä¹±ï¼Œæ²¡æœ‰ä¸€å®šçš„åŠŸåŠ›å¾ˆéš¾å†™çš„å¾ˆæ¼‚äº®é€»è¾‘è¿™ä¹ˆæ¸…æ™°ã€‚\r\n\r\n```jsx\r\n     const keyDir$ = fromEvent(document, \"keydown\").pipe(\r\n         pluck(\"key\"),\r\n         filter((key) => KEY_EVENTS_DIR.includes(key)),\r\n         startWith(\"ArrowRight\"),\r\n         distinctUntilChanged(),\r\n     );\r\n\r\n    const gestureDir$ = function () {\r\n        if ('ontouchstart' in document.documentElement) {\r\n            return fromEvent(document, \"touchstart\").pipe(\r\n                switchMap((startEvent) =>\r\n                    fromEvent(document, \"touchmove\").pipe(\r\n                        takeUntil(fromEvent(document, \"touchend\")),\r\n                        takeLast(1),\r\n                        map((event) => {\r\n                            let deltaX = event.touches[0].pageX - startEvent.touches[0].pageX;\r\n                            let deltaY = event.touches[0].pageY - startEvent.touches[0].pageY;\r\n                            if (deltaX > 0 && Math.abs(deltaX) > Math.abs(deltaY)) {\r\n                                return KEY_EVENTS_DIR[3];\r\n                            } else if (deltaX < 0 && Math.abs(deltaX) > Math.abs(deltaY)) {\r\n                                return KEY_EVENTS_DIR[2];\r\n                            } else if (deltaY > 0 && Math.abs(deltaY) > Math.abs(deltaX)) {\r\n                                return KEY_EVENTS_DIR[1];\r\n                            } else {\r\n                                return KEY_EVENTS_DIR[0]\r\n                            }\r\n                        }),\r\n                    )\r\n                )\r\n            )\r\n        }\r\n        return NEVER\r\n    }()\r\n\r\n    const dir$ = merge(keyDir$, gestureDir$);\r\n    \r\n```\r\n3. è®©è›‡åƒè‹¹æœå˜é•¿\r\n   ç°åœ¨è›‡å¯ä»¥æ§åˆ¶æ–¹å‘4å¤„ç§»åŠ¨äº†ï¼Œä½†æ˜¯è¿˜ä¸èƒ½å˜é•¿ï¼Œæˆ‘ä»¬è¦å®ç°åœ¨è›‡åƒåˆ°è‹¹æœæ—¶é•¿åº¦å¢åŠ 1å¹¶ä¸”è‹¹æœçš„ä½ç½®æ”¹å˜ã€‚è¿™é‡Œæœ‰ç‚¹å¤æ‚ï¼Œå› ä¸ºsnake\\$å’Œfood\\$ç›¸äº’å…³è”äº†èµ·æ¥ã€‚snake\\$éœ€è¦æ‹¿åˆ°å½“å‰food\\$çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦åƒåˆ°ğŸè€Œfood\\$ä¹Ÿéœ€è¦æ‹¿åˆ°snakeçš„å€¼æ¥ç”Ÿæˆæ–°çš„ä½ç½®ä½†ä¸è¦å’Œsnakeçš„ä½ç½®é‡å ã€‚æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°çš„æµeatFood\\$æ¥é€šçŸ¥food\\$ã€‚\r\n   ```jsx\r\n\r\n    //éšæœºç”Ÿæˆé£Ÿç‰©\r\n   const createFood = (size, data) => {\r\n        let x = Math.floor(Math.random() * size);\r\n        let y = Math.floor(Math.random() * size);\r\n        if (data.some(item => item.x === x && item.y === y)) {\r\n            return createFood(size, data);\r\n        }\r\n        return { x, y }\r\n    }\r\n\r\n    const eatFood$ = new BehaviorSubject([]);\r\n\r\n    const food$ = eatFood$.pipe(\r\n        map(snake => createFood(size, snake)),\r\n        shareReplay(1), //ä¸ºä»€ä¹ˆè¦ç”¨shareReplay?\r\n    )\r\n\r\n    const snake$ = interval(1000).pipe(\r\n        withLastFrom(dir$,food$),  //æ¯æ¬¡intervaléƒ½å»å–dirçš„æœ€æ–°å€¼ \r\n        scan((snake,[_,dir,food]) => {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x >= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x <= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y <= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y >= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            snake.unshift({ x: _x, y: _y });\r\n                //åƒåˆ°ğŸ,é€šçŸ¥æ›´æ–°food$\r\n            if (food.x === _x && food.y === _y) {\r\n                eatFood$.next(snake) //é€šçŸ¥food$æ›´æ–°\r\n            } else {\r\n                snake.pop();\r\n            }\r\n            return [...snake];\r\n        },[{x:1,y:1}])\r\n    )\r\n   ```\r\n4. å¢åŠ æš‚åœåŠŸèƒ½\r\n   ç°åœ¨è›‡å·²ç»èƒ½è‡ªç”±ç§»åŠ¨ï¼Œé€šè¿‡åƒğŸä¸æ–­çš„å˜é•¿äº†ï¼Œæ¸¸æˆçš„åŸºæœ¬é€»è¾‘å·²ç»å®ç°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å¢åŠ ä¸€ä¸ªæš‚åœå’Œæ¢å¤çš„åŠŸèƒ½ã€‚è¯·æ³¨æ„çœ‹pauseå®ç°ï¼Œæˆ‘ä»¬é€šè¿‡switchMapæ“ä½œç¬¦æ¥æ§åˆ¶æ˜¯å¦å¾€ä¸‹é¢çš„æµå‘é€å€¼ã€‚\r\n    ```jsx\r\n    const pauseClick$ = fromEvent(document.getElementById(\"pauseORresume\"), \"click\");\r\n\r\n    const pauseKey$ = fromEvent(document, \"keydown\").pipe(\r\n        pluck(\"code\"),\r\n        filter((code) => code === \"Space\")\r\n    )\r\n\r\n    const pause$ = merge(pauseClick$, pauseKey$).pipe(\r\n        startWith(true),\r\n        scan((current, prev) => current ? false : true, false)\r\n    )\r\n\r\n    const interval$ = interval(200);\r\n\r\n    const snake$ = pause$.pipe(\r\n        switchMap((isPaused) => isPaused ? NEVER : inteval$),\r\n        startWith(\"init\"),\r\n        withLastFrom(dir$,food$),  //æ¯æ¬¡intervaléƒ½å»å–dirçš„æœ€æ–°å€¼ \r\n        scan((snake,[_,dir,food]) => {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x >= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x <= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y <= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y >= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            snake.unshift({ x: _x, y: _y });\r\n                //åƒåˆ°ğŸ,é€šçŸ¥æ›´æ–°food$\r\n            if (food.x === _x && food.y === _y) {\r\n                eatFood$.next(snake) //é€šçŸ¥food$æ›´æ–°\r\n            } else {\r\n                snake.pop();\r\n            }\r\n            return [...snake];\r\n        },[{x:1,y:1}])\r\n    )\r\n   ```\r\n5. å¢åŠ gameoveråˆ¤æ–­\r\nç°åœ¨æ¸¸æˆé€»è¾‘åŸºæœ¬å®Œæˆï¼Œä½†æ˜¯ä»€ä¹ˆæ—¶å€™æ¸¸æˆç»“æŸå‘¢ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°isGameOver\\$çš„é€»è¾‘ï¼Œå½“è›‡å’¬åˆ°è‡ªå·±çš„æ—¶å€™æ¸¸æˆç»“æŸï¼Œåœ¨snake\\$é‡Œåšåˆ¤æ–­å°±è¡Œã€‚\r\n```jsx\r\n    const checkGameOver = (snake) => {\r\n        let head = snake[0];\r\n        return snake.slice(1).some(item => item.x === head.x && item.y ===  head.y);\r\n    }\r\n    const snake$ = pause$.pipe(\r\n        switchMap((isPaused) => isPaused ? NEVER : inteval$),\r\n        startWith(\"init\"),\r\n        withLastFrom(dir$,food$),  //æ¯æ¬¡intervaléƒ½å»å–dirçš„æœ€æ–°å€¼ \r\n        scan((snake,[_,dir,food]) => {\r\n            let head = snake[0];\r\n            let _x,_y;\r\n            switch (dir) {\r\n                case \"ArrowRight\":\r\n                    _x = _x >= size - 1 ? 0 : _x + 1;\r\n                    break;\r\n                case \"ArrowLeft\":\r\n                    _x = _x <= 0 ? size - 1 : _x - 1;\r\n                    break;\r\n                case \"ArrowUp\":\r\n                    _y = _y <= 0 ? size - 1 : _y - 1;\r\n                    break;\r\n                case \"ArrowDown\":\r\n                    _y = _y >= size - 1 ? 0 : _y + 1;\r\n                    break;\r\n            }\r\n            snake.unshift({ x: _x, y: _y });\r\n                //åƒåˆ°ğŸ,é€šçŸ¥æ›´æ–°food$\r\n            if (food.x === _x && food.y === _y) {\r\n                eatFood$.next(snake) //é€šçŸ¥food$æ›´æ–°\r\n            } else {\r\n                snake.pop();\r\n            }\r\n            if (checkGameOver(snake)) {\r\n                gameOver$.next(true)\r\n            }\r\n            return [...snake];\r\n        },[{x:1,y:1}])\r\n    )\r\n\r\n```\r\n6. å¢åŠ resetåŠŸèƒ½\r\næ¸¸æˆç»“æŸæ—¶æˆ‘ä»¬è¿˜éœ€è¦é‡ç½®æ¸¸æˆçš„åŠŸèƒ½ã€‚æˆ‘ä»¬å…ˆæŠŠä¹‹å‰çš„é€»è¾‘æ•´ç†æˆä¸€ä¸ªæ–¹æ³•createGameï¼Œç„¶åå†å¢åŠ ä¸€ä¸ªstartGameçš„æ–¹æ³•ï¼Œæ¯æ¬¡resetå°±é‡å»ºä¸€ä¸ªgame\\$è¾¾åˆ°resetçš„ä½œç”¨ã€‚æœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š\r\n```jsx\r\n        const createGame = () => {\r\n        const gameOver$ = new BehaviorSubject(false);\r\n\r\n        const keyDir$ = fromEvent(document, \"keydown\").pipe(\r\n            pluck(\"key\"),\r\n            filter((key) => KEY_EVENTS_DIR.includes(key)),\r\n            startWith(\"ArrowRight\"),\r\n            distinctUntilChanged(),\r\n        );\r\n\r\n        const gestureDir$ = function () {\r\n            if ('ontouchstart' in document.documentElement) {\r\n                return fromEvent(document, \"touchstart\").pipe(\r\n                    switchMap((startEvent) =>\r\n                        fromEvent(document, \"touchmove\").pipe(\r\n                            takeUntil(fromEvent(document, \"touchend\")),\r\n                            takeLast(1),\r\n                            map((event) => {\r\n                                let deltaX = event.touches[0].pageX - startEvent.touches[0].pageX;\r\n                                let deltaY = event.touches[0].pageY - startEvent.touches[0].pageY;\r\n                                if (deltaX > 0 && Math.abs(deltaX) > Math.abs(deltaY)) {\r\n                                    return KEY_EVENTS_DIR[3];\r\n                                } else if (deltaX < 0 && Math.abs(deltaX) > Math.abs(deltaY)) {\r\n                                    return KEY_EVENTS_DIR[2];\r\n                                } else if (deltaY > 0 && Math.abs(deltaY) > Math.abs(deltaX)) {\r\n                                    return KEY_EVENTS_DIR[1];\r\n                                } else {\r\n                                    return KEY_EVENTS_DIR[0]\r\n                                }\r\n                            }),\r\n                        )\r\n                    )\r\n                )\r\n            }\r\n            return NEVER\r\n        }()\r\n\r\n\r\n        const dir$ = merge(keyDir$, gestureDir$);\r\n\r\n        const pauseClick$ = fromEvent(document.getElementById(\"pauseORresume\"), \"click\");\r\n        const pauseKey$ = fromEvent(document, \"keydown\").pipe(\r\n            pluck(\"code\"),\r\n            filter((code) => code === \"Space\")\r\n        )\r\n        const pause$ = merge(pauseClick$, pauseKey$).pipe(\r\n            startWith(true),\r\n            scan((current, prev) => current ? false : true, false)\r\n        )\r\n\r\n        const eatFood$ = new BehaviorSubject([]);\r\n\r\n        const score$ = eatFood$.pipe(\r\n            scan((score, _) => {\r\n                return score + 1\r\n            }, -1)\r\n        )\r\n\r\n        const food$ = eatFood$.pipe(\r\n            map(snake => createFood(size, snake)),\r\n            shareReplay(1),\r\n        )\r\n\r\n        //å¢åŠ å°éœ€æ±‚æ¯åƒ5ä¸ªè‹¹æœé€Ÿåº¦å¢åŠ \r\n        const inteval$ = score$.pipe(\r\n            filter(score => score % 5 === 0),\r\n            map(score => {\r\n                let level = Math.floor(score / 5);\r\n                level = level >= 3 ? 3 : level;\r\n                return INTERVAL_TIMES[level];\r\n            }),\r\n            distinctUntilChanged(),\r\n            switchMap((time) => interval(time)),\r\n        )\r\n\r\n        const snake$ = pause$.pipe(\r\n            switchMap((isPaused) => isPaused ? NEVER : inteval$),\r\n            startWith(\"init\"),\r\n            withLatestFrom(dir$, food$),\r\n            //å¿«é€Ÿåˆ‡æ¢ç›¸åæ–¹å‘å¯¼è‡´è›‡åƒåˆ°è‡ªå·±\r\n            scan((prev, [_, dir, food]) => {\r\n                if (KEY_OPPOSITE[dir] === prev[0]) {\r\n                    return [prev[0], food]\r\n                }\r\n                return [dir, food]\r\n            }, []),\r\n            scan((snake, [dir, food]) => {\r\n                let head = snake[0];\r\n                let _x = head.x;\r\n                let _y = head.y;\r\n                switch (dir) {\r\n                    case \"ArrowRight\":\r\n                        _x = _x >= size - 1 ? 0 : _x + 1;\r\n                        break;\r\n                    case \"ArrowLeft\":\r\n                        _x = _x <= 0 ? size - 1 : _x - 1;\r\n                        break;\r\n                    case \"ArrowUp\":\r\n                        _y = _y <= 0 ? size - 1 : _y - 1;\r\n                        break;\r\n                    case \"ArrowDown\":\r\n                        _y = _y >= size - 1 ? 0 : _y + 1;\r\n                        break;\r\n                }\r\n                snake.unshift({ x: _x, y: _y });\r\n                //åƒåˆ°ğŸ,é€šçŸ¥æ›´æ–°food$\r\n                if (food.x === _x && food.y === _y) {\r\n                    eatFood$.next(snake)\r\n                } else {\r\n                    snake.pop();\r\n                }\r\n                if (checkGameOver(snake)) {\r\n                    gameOver$.next(true)\r\n                }\r\n                return [...snake];\r\n            }, [{ x: 1, y: 1 }]),\r\n        );\r\n\r\n        const game$ = combineLatest([snake$, pause$, food$, score$, gameOver$]).pipe(\r\n            takeWhile(([snake, isPaused, food, score, isGameOver]) => !isGameOver, true)\r\n        )\r\n        return game$;\r\n    }\r\n\r\n\r\n    const renderGame = ([snake, isPaused, food, score, isGameOver]) => {\r\n        setState(state => {\r\n            return {\r\n                ...state,\r\n                snake,\r\n                isPaused,\r\n                food,\r\n                score,\r\n                isGameOver\r\n            }\r\n        })\r\n    }\r\n\r\n    const startGame = () => {\r\n        const reset$ = fromEvent(document.getElementById(\"reset\"), \"click\");\r\n        const game$ = merge(of(\"startGame\"), reset$).pipe(\r\n            switchMap(x => createGame()),\r\n        )\r\n        const sub = game$.subscribe(game => renderGame(game))\r\n        return sub;\r\n    }\r\n\r\n    useEffect(() => {\r\n        let sub = startGame();\r\n\r\n        return () => {\r\n            sub.unsubscribe();\r\n        }\r\n    }, [])\r\n```\r\n\r\n# æ€»ç»“\r\n\r\né€šè¿‡å†™ä¸€ä¸ªè´ªåƒè›‡æ¸¸æˆç¡®å®åŠ æ·±äº†æˆ‘å¯¹rxjsçš„ç†è§£ï¼Œä¹‹å‰æˆ‘ä¹Ÿä»¥ä¸ºæˆ‘å·®ä¸å¤šæ‡‚rxjsçš„ç”¨æ³•äº†ã€‚ä½†æ˜¯çœŸæ­£å†™çš„æ—¶å€™ä¸ºäº†å®ç°å„ç§éœ€æ±‚è¿˜æ˜¯é‡åˆ°äº†å¾ˆå¤šé—®é¢˜ã€‚ä»¥æˆ‘å†™è¿™ä¸ªdemoçš„ç»éªŒæ¥çœ‹ï¼ŒrxjsçœŸçš„æ²¡æœ‰è¯´çš„é‚£ä¹ˆç®€å•ï¼Œä¸ºäº†å®ç°ä¸åŒåŠŸèƒ½åœ¨ä¸åŒçš„æµä¹‹é—´ç©¿æ’å¾ˆè€ƒéªŒä½ å¯¹rxjsçœŸæ­£ç†è§£çš„ç¨‹åº¦ã€‚ä½†æ˜¯ä¸å¾—ä¸æ‰¿è®¤rxjsçœŸçš„å¼ºå¤§ï¼Œé€šè¿‡ç»„åˆå„ç§ç®€å•æ–¹æ³•å®ç°ä¸€ä¸ªå¤æ‚çš„åŠŸèƒ½ï¼Œä»£ç æ€è·¯æ¸…æ™°é€»è¾‘åˆ†æ˜ï¼Œå®¹æ˜“æ‰©å±•å’Œç»´æŠ¤ã€‚é‚£ä¹ˆåˆ°åº•è¦ä¸è¦ç”¨rxjså‘¢?æˆ‘çš„è§‚ç‚¹æ˜¯ä¸€å®šè¦æ¯”è¾ƒæ·±å…¥ç†è§£rxjsäº†å†ç”¨ï¼Œä¸ç„¶ä½ ä¼šé‡åˆ°å¾ˆå¤šéº»çƒ¦çš„ã€‚rxjså¯èƒ½ä¸åƒreactä¸€æ ·ç®€å•ï¼Œéšä¾¿çœ‹çœ‹æ–‡æ¡£æ‡‚äº†jsxå’Œç”Ÿå‘½å‘¨æœŸå°±å¯ä»¥åŠ¨æ‰‹å†™äº†ã€‚\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/3","createdAt":"2021-06-10T16:15:20Z","tags":[{"name":"react","color":"8E26BB"}],"description":"æœ¬æ–‡ä¸»è¦ä»‹ç»ä½¿ç”¨rxjså’Œreactå®ç°ä¸€ä¸ªç»å…¸çš„è´ªåƒè›‡æ¸¸æˆã€‚","keywords":["rxjs","æ¸¸æˆ","è´ªåƒè›‡"]},{"id":"ef06e5380fa3c72d3c8d31deda624cd5","title":"ä½¿ç”¨javascriptç”Ÿæˆpdfæ–‡ä»¶","body":"ä¸€ä¸ªæ•™è‚²ç½‘ç«™é¡¹ç›®æœ‰ä¸ªéœ€æ±‚ï¼Œéœ€è¦åœ¨å­¦å‘˜å®ŒæˆæŸäº›æµ‹è¯•åç”Ÿæˆè¯ä¹¦å¹¶ä¸‹è½½ã€‚æœ¬ä»¥ä¸ºåº”è¯¥æ˜¯è°ƒç”¨åç«¯çš„æ¥å£ç”Ÿæˆï¼Œä½†æ˜¯åç«¯ä¹Ÿè¯´ä¸å¤ªæ‡‚ï¼Œåªå¥½å‰ç«¯æ¥ç ”ç©¶ä¸€ä¸‹è§£å†³æ–¹æ¡ˆã€‚googleä¸€ä¸‹åå‘ç°æ¯”è¾ƒé è°±çš„æœ‰2ç§æ–¹æ¡ˆã€‚\r\n\r\n- ä½¿ç”¨jspdfå’Œhtml2canvasè¿™2ä¸ªåº“åœ¨å‰ç«¯å®ç°\r\n- ä½¿ç”¨nodejsé€šè¿‡puppeteer åœ¨åç«¯ç”Ÿæˆ\r\n\r\nä¸‹é¢åˆ†åˆ«è¯´è¯´è¿™2ç§æ–¹æ³•çš„å®ç°ã€‚\r\n\r\n# ä½¿ç”¨jspdfç”Ÿæˆpdf\r\n\r\n\r\né¦–å…ˆç¼–å†™pdfæ¨¡ç‰ˆçš„html(æˆ‘è¿™é‡Œæ˜¯ç”¨reactå†™çš„)ã€‚\r\n```jsx\r\n<Cert\r\n    chineseName={chineseName}\r\n    englishName={englishName}\r\n    unitInfo={unitInfo}\r\n/>\r\n```\r\nå› ä¸ºè¿™ä¸ªæ¨¡ç‰ˆåªæ˜¯ç”¨æ¥ç”Ÿæˆpdfï¼Œå¹¶ä¸ç”¨æ˜¾ç¤ºï¼Œæ‰€ä»¥é€šè¿‡csså°†å…¶æ”¾åœ¨è§†é‡ä¹‹å¤–ã€‚\r\n```css\r\n.cert {\r\n    width: 870px;\r\n    height: 615px;\r\n    position: absolute;\r\n    // background:transparent url($imgData) ;\r\n    // background-size: 100%;\r\n    // top:-30px;\r\n    left: 5000px;\r\n    visibility: hidden;\r\n    z-index: 99;\r\n}\r\n```\r\næ ¸å¿ƒä»£ç ,å…ˆç”¨html2canvaså°†htmlè½¬æˆcanvasï¼Œå†å°†canvasè½¬æˆimage dataurlï¼Œå†å°†imageå†™å…¥pdfä¸­ã€‚\r\n```jsx\r\nconst savePDF = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n        const jsPDF = (await import(\"jspdf\")).default; //å¼•å…¥jspdf\r\n        const html2canvas = (await import(\"html2canvas\")).default; //å¼•å…¥html2canvas\r\n        let canvas = await html2canvas(document.querySelector(\"#cert\"), {\r\n            scrollY: 0,  //ä¸è®¾ç½®æ­¤å±æ€§ æ»šåŠ¨è§†å›¾æ—¶ä¼šå¯¼è‡´ä¸‹è½½çš„pdfæœ‰éƒ¨åˆ†ä¸æ˜¾ç¤º\r\n            onclone: (clonedDoc) => {\r\n                clonedDoc.getElementById(\"cert\").style.visibility = 'visible'; //å°†pdfæ¨¡ç‰ˆè®¾ä¸ºå¯è§\r\n            }\r\n        })\r\n        var imgData = canvas.toDataURL('image/png');\r\n        var doc = new jsPDF('l', 'mm', \"a4\", true); \r\n        var width = doc.internal.pageSize.getWidth();\r\n        var height = doc.internal.pageSize.getHeight();\r\n        doc.addImage(imgData, 'PNG', 0, 0, width, height, \"\", \"FAST\"); //FAST æ˜¯å¦å‹ç¼©\r\n        // let pdf = doc.output('blob');\r\n        // let form = new FormData();\r\n        doc.output('save', 'Certificate.pdf');\r\n    } catch (err) {\r\n        console.log(err);\r\n    } finally {\r\n        setIsLoading(false)\r\n    }\r\n}\r\n```\r\nè¿™å°±å¤§åŠŸå‘Šæˆäº†ï¼Ÿé«˜å…´çš„å¤ªæ—©ï¼ğŸ˜­ğŸ˜­ğŸ˜­é—®é¢˜æ€»æ˜¯å±‚å‡ºä¸ç©·çš„å¤šã€‚åœ¨ç”¨æ­¤æ–¹æ³•ä¸­ä¸€å…±é‡åˆ°ä¸‰ä¸ªè¾ƒå¤§çš„é—®é¢˜ã€‚\r\n\r\n1. åˆæ­¥å®ç°åŠŸèƒ½æäº¤åï¼Œä¸€å¤©qaçªç„¶å’Œæˆ‘è¯´æ€ä¹ˆç”Ÿæˆçš„pdfä¸ŠåŠéƒ¨åˆ†æ˜¯ç©ºç™½çš„ã€‚æ²¡åŠæ³•ï¼Œæ‰¾æ‰¾æ‰¾ã€‚é€šè¿‡googleï¼Œå‘ç°æ˜¯html2canvasæ—¶ä¼šæ ¹æ®ç”¨æˆ·æ»šåŠ¨çš„ä½ç½®æ¥è®¡ç®—çš„ï¼Œè®¾ç½®scrollY: 0è§£å†³ã€‚\r\n2. ä¹‹å‰åœ¨devåœºä¸­æµ‹è¯•å¹¶æ²¡æœ‰å‘ç°é—®é¢˜ï¼Œä½†æ˜¯ä¸Šäº†uatåå‘ç°pdfä¸­å›¾ç‰‡æ²¡åŠ è½½ã€‚æœ€åå‘ç°æ˜¯å› ä¸ºuatåœºå›¾ç‰‡å…¨éƒ¨æ”¾åœ¨äº†cdnçš„ç¼˜æ•…ï¼Œpdfä¸ä¼šåŠ è½½éåŒæºç«™çš„å›¾ç‰‡ä¹Ÿå°±è·¨åŸŸï¼Œè®¾ç½®useCORSä¹Ÿæ²¡æœ‰ç”¨ã€‚æœ€åç›´æ¥æŠŠpdfä¸­ç”¨åˆ°çš„å›¾ç‰‡æ¢æˆbase64è§£å†³ã€‚\r\n3. ä¸åŒçš„æµè§ˆå™¨å’Œè®¾å¤‡ç”Ÿæˆçš„pdfæ–‡ä»¶sizeä¸åŒã€‚æœ‰çš„åªæœ‰å‡ M,æœ‰çš„åå‡ Mã€‚è¿™ä¸ªåº”è¯¥å’Œè®¾å¤‡çš„åˆ†è¾¨ç‡æœ‰å…³ã€‚è®¾ç½®äº†æ˜¯å¦å‹ç¼©ï¼Œå¯ä»¥è°ƒèŠ‚pdfçš„sizeï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•ç»Ÿä¸€ç”Ÿæˆçš„pdfçš„sizeã€‚\r\n\r\n# ä½¿ç”¨puppeteeråç«¯ç”Ÿæˆpdf \r\n\r\nåšè¿‡çˆ¬è™«çš„åº”è¯¥éƒ½å¬è¿‡é¼é¼å¤§åçš„phantomjsï¼Œå½“å¹´è¿™ä¸ªåº“å¾ˆç«ï¼Œå¯ä»¥è¯´æ˜¯ä¸€äº›æ¯”è¾ƒå¤æ‚ç½‘ç«™çš„çˆ¬è™«æœ€ç»ˆè§£å†³æ–¹æ¡ˆã€‚å› ä¸ºå®ƒå¯ä»¥è®©ä½ ç”¨jsæ“ä½œä¸€ä¸ªçœŸæ­£çš„æµè§ˆå™¨å»è®¿é—®ç½‘ç«™ã€‚puppeteeræ˜¯googleæ¨å‡ºçš„headless chromeï¼Œå¯ä»¥è¯´æ˜¯phantomjsçš„æ›¿ä»£å“ï¼Œè‡ªä»è¿™ä¸ªåº“å‡ºä¸–ï¼Œphantomjså¥½åƒå°±åœæ­¢ç»´æŠ¤äº†ã€‚\r\n\r\n>  Puppeteer is a Node library which provides a high-level API to control Chrome or Chromium over the DevTools Protocol. Puppeteer runs headless by default, but can be configured to run full (non-headless) Chrome or Chromium.\r\n\r\nä¸ºäº†è§£å†³ä¸Šé¢è¯´çš„ä¸åŒè®¾å¤‡ç”Ÿæˆçš„pdf sizeä¸åŒçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨puppeteeræ¥åœ¨åç«¯ç”Ÿæˆpdfã€‚\r\nå› ä¸ºç”Ÿæˆçš„è¯ä¹¦å¦‚å§“åæˆç»©ä¹‹ç±»çš„æ˜¯åŠ¨æ€çš„ï¼Œæ‰€ä»¥è¦ç”¨æ¨¡ç‰ˆåŠ¨æ€ç”Ÿæˆï¼Œå› ä¸ºæˆ‘çš„é¡¹ç›®æ˜¯reactï¼Œæ‰€ä»¥ç›´æ¥ç”¨jsxç”Ÿæˆæ¨¡æ¿ï¼Œç”¨rendertostringç”Ÿæˆhtmlå­—ç¬¦ä¸²ã€‚ä¹Ÿæœ‰ä¸€äº›styleå’Œå›¾ç‰‡å¤„ç†æ¯”è¾ƒéº»çƒ¦ï¼Œå¯ä»¥çœ‹æˆ‘ä»£ç ï¼Œä½†æ˜¯è¿™é‡Œåªæ˜¯ç®€å•å®ç°ã€‚\r\n\r\n```jsx\r\nconst PdfTemplate = ({ imgSrc }) => {\r\n    return (\r\n        <div className=\"bg\">\r\n            <h2>heading</h2>\r\n            <div>\r\n                content\r\n            </div>\r\n            <img src={imgSrc} alt=\"\" style={{ width: \"100%\", height: 300 }} />\r\n        </div>\r\n    )\r\n}\r\n\r\nconst createHtmlStr = () => {\r\n    const imagePath = __dirname + \"/../../../../public/images/bg.jpeg\";\r\n    const imgData = fs.readFileSync(imagePath).toString(\"base64\");\r\n    const imgSrc = `data:image/jpeg;base64,${imgData}`;\r\n    const content = ReactDOMServer.renderToString(<PdfTemplate imgSrc={imgSrc} />)\r\n    return `\r\n        <html>\r\n            <head>\r\n                <style>\r\n                    html,body{\r\n                        margin:0;\r\n                        padding:0;\r\n                        height:100%\r\n                    }\r\n                    .bg{\r\n                        height:100%;\r\n                        position:relative;\r\n                    }\r\n                </style>\r\n            </head>\r\n            <body>\r\n                ${content}\r\n            </body>\r\n        </html>\r\n    `\r\n}\r\n```\r\nåç«¯ä»£ç \r\n```javascript\r\nexport default async function handler(req, res) {\r\n    console.log(\"start\")\r\n    const browser = await puppeteer.launch({\r\n        args: ['--disable-dev-shm-usage', '--no-sandbox']\r\n    });\r\n    const page = await browser.newPage();\r\n    ;\r\n    const html = createHtmlStr();\r\n    console.log(html, \"====\")\r\n    // await page.goto(\"http://localhost:3000/\");\r\n    await page.setContent(html);\r\n    const pdf = await page.pdf({\r\n        format: 'A4',\r\n        printBackground: true,\r\n        '-webkit-print-color-adjust': 'exact',\r\n    });\r\n    await browser.close();\r\n    console.log(\"end render\");\r\n    res.setHeader(\"Content-Type\", 'application/pdf');\r\n    res.status(200);\r\n    res.send(pdf);\r\n}\r\n\r\n```\r\nå‰ç«¯ä»£ç \r\n```javascript\r\n  const downloadPDF = async () => {\r\n          let response = await fetch(\"/api/createPdf\", {\r\n              responseType: 'arraybuffer',\r\n              headers: {\r\n                  'Accept': 'application/pdf'\r\n              }\r\n          });\r\n          let blob = await response.blob();\r\n          // const blob = new Blob([response.body], { type: 'application/pdf' })\r\n          const link = document.createElement('a')\r\n          link.href = window.URL.createObjectURL(blob)\r\n          link.download = `your-file-name.pdf`\r\n          link.click()\r\n  }\r\n```\r\n# æ€»ç»“\r\n\r\n1. åœ¨å‰ç«¯é€šè¿‡æˆªå±htmlå…ƒç´ ç”Ÿæˆpdfï¼Œç®€å•æ–¹ä¾¿ï¼Œä¸éœ€è¦åç«¯é…åˆï¼Œç›´æ¥åœ¨å‰ç«¯ç”Ÿæˆpdfï¼Œç¼ºç‚¹å°±æ˜¯ç”Ÿæˆçš„pdfæ–‡ä»¶å¤§å°ä¸ç»Ÿä¸€ã€‚\r\n2. åœ¨åç«¯ç”¨puppeteerç”Ÿæˆpdfï¼Œå¯ä»¥è§£å†³ä¸Šè¿°æ–¹æ³•çš„é—®é¢˜ï¼Œä½†æ˜¯è¦å¼•å…¥ä¸€ä¸ªæ–°çš„æ¥å£ï¼Œéœ€è¦åŠ ä¸€ä¸ªnodeæœåŠ¡ï¼Œè¿™ä¸ªé¡¹ç›®å› ä¸ºæˆ‘ä»¬æ˜¯ç”¨nextjså†™çš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿çš„åŠ ä¸€ä¸ªapiæ¥å£ã€‚ä½†æ˜¯ä¸€èˆ¬æˆ‘ä»¬çš„åç«¯éƒ½æ˜¯javaå†™çš„ï¼Œè¦é¢å¤–çš„å¼€ä¸€ä¸ªnodeæœåŠ¡ä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿ã€‚\r\n\r\n","url":"https://github.com/gwl002/gwl002.github.io/issues/2","createdAt":"2021-06-06T14:54:27Z","tags":[{"name":"å·¥ä½œç»éªŒ","color":"bfdadc"}]}],"tags":[{"name":"javascript","color":"1d76db"},{"name":"react","color":"8E26BB"},{"name":"css","color":"F49416"},{"name":"å·¥ä½œç»éªŒ","color":"bfdadc"},{"name":"react-native","color":"5319e7"}],"title":"æ ‡ç­¾","subTitle":"æŠŠæ–‡ç« æŒ‰æ ‡ç­¾æ•´ç†åˆ†ç±»"},"__N_SSG":true}